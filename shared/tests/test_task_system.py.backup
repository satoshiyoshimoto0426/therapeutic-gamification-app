"""
[UNICODE_30BF]XP[UNICODE_8A08]
Task system and XP calculation comprehensive tests
Requirements: 5.1, 5.2
"""

import pytest
from datetime import datetime, timedelta
from shared.interfaces.task_system import (
    Task, TaskDifficulty, TaskPriority, ADHDSupportLevel,
    TaskXPCalculator, XPCalculationResult, TaskTypeRecommender
)
from shared.interfaces.task_validation import TaskValidator, TaskBusinessRules, TaskMetrics
from shared.interfaces.core_types import TaskType, TaskStatus, CrystalAttribute


class TestTaskSystem:
    """[UNICODE_30BF]"""
    
    def test_task_creation(self):
        """[UNICODE_57FA]"""
        task = Task(
            task_id="test_task_001",
            uid="test_user",
            task_type=TaskType.ONE_SHOT,
            title="[UNICODE_30C6]",
            description="[UNICODE_3053]",
            difficulty=TaskDifficulty.MEDIUM
        )
        
        assert task.task_id == "test_task_001"
        assert task.uid == "test_user"
        assert task.task_type == TaskType.ONE_SHOT
        assert task.title == "[UNICODE_30C6]"
        assert task.difficulty == TaskDifficulty.MEDIUM
        assert task.status == TaskStatus.PENDING
        assert task.base_xp > 0  # [UNICODE_81EA]
        print(f"[UNICODE_2713] Task created with base XP: {task.base_xp}")
    
    def test_base_xp_calculation(self):
        """[UNICODE_57FA]XP[UNICODE_306E]"""
        # [UNICODE_96E3]
        difficulties_and_expected_xp = [
            (TaskDifficulty.VERY_EASY, 5),
            (TaskDifficulty.EASY, 10),
            (TaskDifficulty.MEDIUM, 15),
            (TaskDifficulty.HARD, 25),
            (TaskDifficulty.VERY_HARD, 40)
        ]
        
        for difficulty, expected_base in difficulties_and_expected_xp:
            task = Task(
                task_id=f"test_{difficulty}",
                uid="test_user",
                task_type=TaskType.ONE_SHOT,
                title="Test Task",
                difficulty=difficulty
            )
            assert task.base_xp == expected_base
            print(f"[UNICODE_2713] {difficulty.name}: {task.base_xp} XP")
    
    def test_task_lifecycle(self):
        """[UNICODE_30BF]"""
        task = Task(
            task_id="lifecycle_test",
            uid="test_user",
            task_type=TaskType.ONE_SHOT,
            title="[UNICODE_30E9]",
            difficulty=TaskDifficulty.MEDIUM
        )
        
        # [UNICODE_521D]
        assert task.status == TaskStatus.PENDING
        assert task.started_at is None
        assert task.completed_at is None
        print("[UNICODE_2713] Initial state: PENDING")
        
        # [UNICODE_30BF]
        task.start_task()
        assert task.status == TaskStatus.IN_PROGRESS
        assert task.started_at is not None
        print("[UNICODE_2713] Task started: IN_PROGRESS")
        
        # [UNICODE_30BF]
        xp_earned = task.complete_task(mood_score=4, actual_duration=25)
        assert task.status == TaskStatus.COMPLETED
        assert task.completed_at is not None
        assert task.mood_at_completion == 4
        assert task.actual_duration == 25
        assert xp_earned > 0
        assert task.xp_earned == xp_earned
        print(f"[UNICODE_2713] Task completed: {xp_earned} XP earned")
    
    def test_xp_calculation_with_mood(self):
        """[UNICODE_6C17]XP[UNICODE_8A08]"""
        mood_tests = [
            (1, 0.8),  # [UNICODE_6700] -> 0.8[UNICODE_500D]
            (3, 1.0),  # [UNICODE_666E] -> 1.0[UNICODE_500D]
            (5, 1.2)   # [UNICODE_6700] -> 1.2[UNICODE_500D]
        ]
        
        for mood_score, expected_coefficient in mood_tests:
            task = Task(
                task_id=f"mood_test_{mood_score}",
                uid="test_user",
                task_type=TaskType.ONE_SHOT,
                title="[UNICODE_6C17]",
                difficulty=TaskDifficulty.MEDIUM  # base_xp = 15
            )
            task.start_task()
            
            xp_earned = task.complete_task(mood_score=mood_score)
            expected_xp = int(15 * expected_coefficient)  # base_xp * mood_coefficient
            assert xp_earned == expected_xp
            print(f"[UNICODE_2713] Mood {mood_score}: {xp_earned} XP (coefficient: {expected_coefficient})")


class TestTaskXPCalculator:
    """TaskXPCalculator[UNICODE_30AF]"""
    
    def test_detailed_xp_calculation(self):
        """[UNICODE_8A73]XP[UNICODE_8A08]"""
        task = Task(
            task_id="detailed_xp_test",
            uid="test_user",
            task_type=TaskType.ONE_SHOT,
            title="[UNICODE_8A73]XP[UNICODE_8A08]",
            difficulty=TaskDifficulty.MEDIUM,
            priority=TaskPriority.HIGH,
            adhd_support_level=ADHDSupportLevel.BASIC,
            estimated_duration=30
        )
        
        result = TaskXPCalculator.calculate_detailed_xp(
            task=task,
            mood_score=4,
            actual_duration=25
        )
        
        assert isinstance(result, XPCalculationResult)
        assert result.base_xp == task.base_xp
        assert result.mood_coefficient == 1.1  # mood_score 4 -> 1.1
        assert result.adhd_assist_multiplier == 1.1  # BASIC level
        assert result.time_efficiency_bonus > 1.0  # [UNICODE_4E88]
        assert result.priority_bonus == 1.1  # HIGH priority
        assert result.final_xp > result.base_xp
        assert "base" in result.breakdown
        assert "mood" in result.breakdown
        
        print(f"[UNICODE_2713] Detailed XP calculation: {result.final_xp} XP")
        print(f"  - Base: {result.base_xp}")
        print(f"  - Mood coefficient: {result.mood_coefficient}")
        print(f"  - ADHD assist: {result.adhd_assist_multiplier}")
        print(f"  - Time efficiency: {result.time_efficiency_bonus}")
        print(f"  - Priority bonus: {result.priority_bonus}")
    
    def test_xp_preview(self):
        """XP[UNICODE_30D7]"""
        preview_xp = TaskXPCalculator.get_xp_preview(
            task_type=TaskType.SKILL_UP,
            difficulty=TaskDifficulty.HARD,
            mood_score=3,
            adhd_support_level=ADHDSupportLevel.MODERATE
        )
        
        assert isinstance(preview_xp, int)
        assert preview_xp > 0
        print(f"[UNICODE_2713] XP Preview: {preview_xp} XP for SKILL_UP/HARD task")


class TestTaskTypeRecommender:
    """TaskTypeRecommender[UNICODE_30AF]"""
    
    def test_crystal_attribute_recommendation(self):
        """[UNICODE_30AF]"""
        # ROUTINE[UNICODE_30BF]
        routine_attrs = TaskTypeRecommender.recommend_crystal_attributes(TaskType.ROUTINE)
        assert CrystalAttribute.SELF_DISCIPLINE in routine_attrs
        assert CrystalAttribute.RESILIENCE in routine_attrs
        print(f"[UNICODE_2713] ROUTINE task attributes: {[attr.value for attr in routine_attrs]}")
        
        # SOCIAL[UNICODE_30BF]
        social_attrs = TaskTypeRecommender.recommend_crystal_attributes(TaskType.SOCIAL)
        assert CrystalAttribute.EMPATHY in social_attrs
        assert CrystalAttribute.COMMUNICATION in social_attrs
        print(f"[UNICODE_2713] SOCIAL task attributes: {[attr.value for attr in social_attrs]}")
    
    def test_task_type_recommendation(self):
        """[UNICODE_30BF]"""
        test_cases = [
            ("[UNICODE_6BCE]", TaskType.ROUTINE),
            ("[UNICODE_53CB]", TaskType.SOCIAL),
            ("[UNICODE_30D7]", TaskType.SKILL_UP),
            ("[UNICODE_4ECA]", TaskType.ONE_SHOT)
        ]
        
        for goal, expected_type in test_cases:
            recommended_type = TaskTypeRecommender.recommend_task_type(goal)
            assert recommended_type == expected_type
            print(f"[UNICODE_2713] '{goal}' -> {recommended_type.value}")


class TestTaskValidator:
    """TaskValidator[UNICODE_30AF]"""
    
    def test_task_creation_validation(self):
        """[UNICODE_30BF]"""
        # [UNICODE_6709]
        valid_task_data = {
            'task_id': 'valid_task',
            'uid': 'test_user',
            'task_type': TaskType.ONE_SHOT,
            'title': '[UNICODE_6709]',
            'difficulty': TaskDifficulty.MEDIUM,
            'description': '[UNICODE_3053]',
            'estimated_duration': 30,
            'tags': ['[UNICODE_30C6]', '[UNICODE_6709]']
        }
        
        is_valid, errors = TaskValidator.validate_task_creation(valid_task_data)
        assert is_valid is True
        assert len(errors) == 0
        print("[UNICODE_2713] Valid task data passed validation")
        
        # [UNICODE_7121]
        invalid_task_data = valid_task_data.copy()
        invalid_task_data['title'] = '[UNICODE_3042]' * 101  # 101[UNICODE_6587]
        
        is_valid, errors = TaskValidator.validate_task_creation(invalid_task_data)
        assert is_valid is False
        assert len(errors) > 0
        print(f"[UNICODE_2713] Invalid task data rejected: {errors[0]}")
    
    def test_task_completion_validation(self):
        """[UNICODE_30BF]"""
        task = Task(
            task_id="completion_test",
            uid="test_user",
            task_type=TaskType.ONE_SHOT,
            title="[UNICODE_5B8C]",
            difficulty=TaskDifficulty.MEDIUM
        )
        
        # [UNICODE_9032]
        is_valid, errors = TaskValidator.validate_task_completion(task, 3)
        assert is_valid is False
        assert "[UNICODE_9032]" in errors[0]
        print("[UNICODE_2713] Non-in-progress task completion rejected")
        
        # [UNICODE_9032]
        task.start_task()
        is_valid, errors = TaskValidator.validate_task_completion(task, 3)
        assert is_valid is True
        assert len(errors) == 0
        print("[UNICODE_2713] In-progress task completion validated")


class TestTaskBusinessRules:
    """TaskBusinessRules[UNICODE_30AF]"""
    
    def test_daily_task_limit(self):
        """[UNICODE_65E5]"""
        # [UNICODE_5236]
        can_create, message = TaskBusinessRules.can_user_create_task("user1", 10, 16)
        assert can_create is True
        print("[UNICODE_2713] Within daily limit: can create task")
        
        # [UNICODE_5236]
        can_create, message = TaskBusinessRules.can_user_create_task("user1", 16, 16)
        assert can_create is False
        assert "[UNICODE_5236]" in message
        print(f"[UNICODE_2713] Over daily limit: {message}")
    
    def test_urgency_score_calculation(self):
        """[UNICODE_7DCA]"""
        # 2[UNICODE_6642]
        due_date = datetime.utcnow() + timedelta(hours=2)
        urgency_score = TaskBusinessRules.calculate_urgency_score(
            due_date, TaskPriority.HIGH, TaskDifficulty.MEDIUM
        )
        
        assert 0.0 <= urgency_score <= 1.0
        assert urgency_score > 0.5  # 2[UNICODE_6642]
        print(f"[UNICODE_2713] Urgency score for 2h deadline: {urgency_score:.2f}")


class TestTaskMetrics:
    """TaskMetrics[UNICODE_30AF]"""
    
    def test_completion_rate_calculation(self):
        """[UNICODE_5B8C]"""
        completion_rate = TaskMetrics.calculate_completion_rate(8, 10)
        assert completion_rate == 0.8
        print(f"[UNICODE_2713] Completion rate: {completion_rate * 100}%")
    
    def test_time_estimation_accuracy(self):
        """[UNICODE_6642]"""
        estimated = [30, 45, 60, 20]
        actual = [35, 40, 65, 18]
        
        accuracy = TaskMetrics.calculate_time_estimation_accuracy(estimated, actual)
        assert 0.0 <= accuracy <= 1.0
        print(f"[UNICODE_2713] Time estimation accuracy: {accuracy * 100:.1f}%")


def run_all_tests():
    """[UNICODE_5168]"""
    print("=== Running Task System Tests ===")
    
    # [UNICODE_57FA]
    task_test = TestTaskSystem()
    task_test.test_task_creation()
    task_test.test_base_xp_calculation()
    task_test.test_task_lifecycle()
    task_test.test_xp_calculation_with_mood()
    print("[UNICODE_2713] Basic task system tests passed\n")
    
    # XP[UNICODE_8A08]
    xp_calc_test = TestTaskXPCalculator()
    xp_calc_test.test_detailed_xp_calculation()
    xp_calc_test.test_xp_preview()
    print("[UNICODE_2713] XP calculation tests passed\n")
    
    # [UNICODE_63A8]
    recommender_test = TestTaskTypeRecommender()
    recommender_test.test_crystal_attribute_recommendation()
    recommender_test.test_task_type_recommendation()
    print("[UNICODE_2713] Task type recommender tests passed\n")
    
    # [UNICODE_30D0]
    validator_test = TestTaskValidator()
    validator_test.test_task_creation_validation()
    validator_test.test_task_completion_validation()
    print("[UNICODE_2713] Task validation tests passed\n")
    
    # [UNICODE_30D3]
    business_test = TestTaskBusinessRules()
    business_test.test_daily_task_limit()
    business_test.test_urgency_score_calculation()
    print("[UNICODE_2713] Business rules tests passed\n")
    
    # [UNICODE_30E1]
    metrics_test = TestTaskMetrics()
    metrics_test.test_completion_rate_calculation()
    metrics_test.test_time_estimation_accuracy()
    print("[UNICODE_2713] Task metrics tests passed\n")
    
    print("=== All Task System Tests Passed! ===")


if __name__ == "__main__":
    run_all_tests()