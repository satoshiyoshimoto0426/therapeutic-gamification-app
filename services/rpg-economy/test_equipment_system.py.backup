"""
[UNICODE_88C5]

6[UNICODE_30B9]6[UNICODE_7A2E]
[UNICODE_88C5]
"""

import unittest
import sys
import os
from datetime import datetime

# [UNICODE_30D1]
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))

from equipment_system import (
    EquipmentSystem, EquipmentSet, EquipmentSlot, StatType, EquipmentStats, TaskCompletionBonus
)
from gacha_system import GachaSystem, Item, ItemType, ItemRarity, TherapeuticTheme
from shared.utils.exceptions import ValidationError


class TestEquipmentSystem(unittest.TestCase):
    """[UNICODE_88C5]"""
    
    def setUp(self):
        """[UNICODE_30C6]"""
        self.equipment_system = EquipmentSystem()
        self.equipment_set = EquipmentSet()
        self.gacha_system = GachaSystem()
        
        # [UNICODE_30C6]
        self.test_weapon = self._create_test_item(
            "[UNICODE_30C6]", ItemType.WEAPON, ItemRarity.RARE,
            {"focus": 5, "motivation": 3}, ["task_focus_boost"]
        )
        
        self.test_armor = self._create_test_item(
            "[UNICODE_30C6]", ItemType.ARMOR, ItemRarity.UNCOMMON,
            {"resilience": 4, "social": 2}, ["productivity_enhance"]
        )
        
        self.test_accessory = self._create_test_item(
            "[UNICODE_30C6]", ItemType.ACCESSORY, ItemRarity.EPIC,
            {"wisdom": 8, "creativity": 6}, ["deep_work_mode"]
        )
        
        self.test_consumable = self._create_test_item(
            "[UNICODE_30C6]", ItemType.CONSUMABLE, ItemRarity.COMMON,
            {"motivation": 2}, ["energy_boost"]
        )
    
    def _create_test_item(self, name: str, item_type: ItemType, rarity: ItemRarity,
                         stat_bonuses: dict, special_effects: list) -> Item:
        """[UNICODE_30C6]"""
        return Item(
            id=f"test_{name}",
            name=name,
            description=f"{name}[UNICODE_306E]",
            rarity=rarity,
            item_type=item_type,
            therapeutic_theme=TherapeuticTheme.FOCUS,
            stat_bonuses=stat_bonuses,
            special_effects=special_effects,
            flavor_text=f"{name}[UNICODE_306E]",
            created_at=datetime.now()
        )
    
    def test_equip_item_success(self):
        """[UNICODE_30A2]"""
        success, message = self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        
        self.assertTrue(success)
        self.assertIn("[UNICODE_88C5]", message)
        self.assertEqual(self.equipment_set.weapon, self.test_weapon)
    
    def test_equip_item_replace(self):
        """[UNICODE_30A2]"""
        # [UNICODE_6700]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        
        # [UNICODE_5225]
        new_weapon = self._create_test_item(
            "[UNICODE_65B0]", ItemType.WEAPON, ItemRarity.LEGENDARY,
            {"focus": 10}, ["motivation_boost"]
        )
        
        success, message = self.equipment_system.equip_item(
            self.equipment_set, new_weapon, EquipmentSlot.WEAPON
        )
        
        self.assertTrue(success)
        self.assertIn("[UNICODE_5916]", message)
        self.assertIn("[UNICODE_88C5]", message)
        self.assertEqual(self.equipment_set.weapon, new_weapon)
    
    def test_equip_item_wrong_type(self):
        """[UNICODE_4E0D]"""
        success, message = self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.ARMOR
        )
        
        self.assertFalse(success)
        self.assertIn("[UNICODE_88C5]", message)
    
    def test_unequip_item_success(self):
        """[UNICODE_30A2]"""
        # [UNICODE_307E]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        
        # [UNICODE_88C5]
        success, message = self.equipment_system.unequip_item(
            self.equipment_set, EquipmentSlot.WEAPON
        )
        
        self.assertTrue(success)
        self.assertIn("[UNICODE_5916]", message)
        self.assertIsNone(self.equipment_set.weapon)
    
    def test_unequip_empty_slot(self):
        """[UNICODE_7A7A]"""
        success, message = self.equipment_system.unequip_item(
            self.equipment_set, EquipmentSlot.WEAPON
        )
        
        self.assertFalse(success)
        self.assertIn("[UNICODE_4F55]", message)
    
    def test_calculate_total_stats(self):
        """[UNICODE_7DCF]"""
        # [UNICODE_8907]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        self.equipment_system.equip_item(
            self.equipment_set, self.test_armor, EquipmentSlot.ARMOR
        )
        self.equipment_system.equip_item(
            self.equipment_set, self.test_accessory, EquipmentSlot.ACCESSORY
        )
        
        total_stats = self.equipment_system.calculate_total_stats(self.equipment_set)
        
        # [UNICODE_671F]: weapon(focus:5, motivation:3) + armor(resilience:4, social:2) + accessory(wisdom:8, creativity:6)
        self.assertEqual(total_stats.focus, 5)
        self.assertEqual(total_stats.motivation, 3)
        self.assertEqual(total_stats.resilience, 4)
        self.assertEqual(total_stats.social, 2)
        self.assertEqual(total_stats.wisdom, 8)
        self.assertEqual(total_stats.creativity, 6)
    
    def test_calculate_task_completion_bonus(self):
        """[UNICODE_30BF]"""
        # [UNICODE_30A2]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        
        bonus = self.equipment_system.calculate_task_completion_bonus(self.equipment_set)
        
        self.assertIsInstance(bonus, TaskCompletionBonus)
        self.assertGreater(bonus.total_bonus, 0)
        self.assertGreater(bonus.focus_bonus, 0)
        self.assertIn("task_focus_boost", bonus.active_effects)
        
        # [UNICODE_96C6] (focus:5 * 0.02 = 0.1)
        expected_focus_bonus = 5 * 0.02
        self.assertAlmostEqual(bonus.focus_bonus, expected_focus_bonus, places=3)
    
    def test_max_bonus_limit(self):
        """[UNICODE_6700]"""
        # [UNICODE_975E]
        super_item = self._create_test_item(
            "[UNICODE_8D85]", ItemType.WEAPON, ItemRarity.LEGENDARY,
            {"focus": 100, "motivation": 100}, ["task_focus_boost", "motivation_boost", "deep_work_mode"]
        )
        
        self.equipment_system.equip_item(
            self.equipment_set, super_item, EquipmentSlot.WEAPON
        )
        
        bonus = self.equipment_system.calculate_task_completion_bonus(self.equipment_set)
        
        # [UNICODE_6700]50%[UNICODE_5236]
        self.assertLessEqual(bonus.total_bonus, 0.5)
    
    def test_equipment_stats_operations(self):
        """EquipmentStats[UNICODE_6F14]"""
        stats1 = EquipmentStats(focus=5, motivation=3, resilience=2)
        stats2 = EquipmentStats(focus=2, wisdom=4, creativity=1)
        
        # [UNICODE_52A0]
        result_add = stats1 + stats2
        self.assertEqual(result_add.focus, 7)
        self.assertEqual(result_add.motivation, 3)
        self.assertEqual(result_add.wisdom, 4)
        
        # [UNICODE_6E1B]
        result_sub = stats1 - stats2
        self.assertEqual(result_sub.focus, 3)
        self.assertEqual(result_sub.motivation, 3)
        self.assertEqual(result_sub.wisdom, -4)
        
        # [UNICODE_8F9E]
        stats_dict = stats1.to_dict()
        self.assertEqual(stats_dict["focus"], 5)
        self.assertEqual(stats_dict["motivation"], 3)
        
        # [UNICODE_8F9E]
        stats_from_dict = EquipmentStats.from_dict(stats_dict)
        self.assertEqual(stats_from_dict.focus, 5)
        self.assertEqual(stats_from_dict.motivation, 3)
    
    def test_equipment_summary(self):
        """[UNICODE_88C5]"""
        # [UNICODE_8907]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        self.equipment_system.equip_item(
            self.equipment_set, self.test_armor, EquipmentSlot.ARMOR
        )
        
        summary = self.equipment_system.get_equipment_summary(self.equipment_set)
        
        self.assertEqual(summary["total_equipped"], 2)
        self.assertTrue(summary["slot_status"]["weapon"]["equipped"])
        self.assertTrue(summary["slot_status"]["armor"]["equipped"])
        self.assertFalse(summary["slot_status"]["accessory"]["equipped"])
        
        self.assertIn("total_stats", summary)
        self.assertIn("completion_bonus", summary)
        self.assertIn("rarity_distribution", summary)
        
        # [UNICODE_30EC]
        self.assertEqual(summary["rarity_distribution"]["rare"], 1)  # weapon
        self.assertEqual(summary["rarity_distribution"]["uncommon"], 1)  # armor
    
    def test_consumable_slots(self):
        """[UNICODE_6D88]"""
        consumable1 = self._create_test_item("[UNICODE_30DD]1", ItemType.CONSUMABLE, ItemRarity.COMMON, {"focus": 1}, [])
        consumable2 = self._create_test_item("[UNICODE_30DD]2", ItemType.CONSUMABLE, ItemRarity.COMMON, {"motivation": 1}, [])
        consumable3 = self._create_test_item("[UNICODE_30DD]3", ItemType.CONSUMABLE, ItemRarity.COMMON, {"resilience": 1}, [])
        
        # 3[UNICODE_3064]
        self.equipment_system.equip_item(self.equipment_set, consumable1, EquipmentSlot.CONSUMABLE_1)
        self.equipment_system.equip_item(self.equipment_set, consumable2, EquipmentSlot.CONSUMABLE_2)
        self.equipment_system.equip_item(self.equipment_set, consumable3, EquipmentSlot.CONSUMABLE_3)
        
        total_stats = self.equipment_system.calculate_total_stats(self.equipment_set)
        
        self.assertEqual(total_stats.focus, 1)
        self.assertEqual(total_stats.motivation, 1)
        self.assertEqual(total_stats.resilience, 1)
    
    def test_equipment_validation(self):
        """[UNICODE_88C5]"""
        # [UNICODE_6B63]
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        
        valid, errors = self.equipment_system.validate_equipment_set(self.equipment_set)
        self.assertTrue(valid)
        self.assertEqual(len(errors), 0)
        
        # [UNICODE_4E0D]
        invalid_equipment = EquipmentSet()
        invalid_equipment.weapon = self.test_armor  # [UNICODE_6B66]
        
        valid, errors = self.equipment_system.validate_equipment_set(invalid_equipment)
        self.assertFalse(valid)
        self.assertGreater(len(errors), 0)
    
    def test_stat_breakdown(self):
        """[UNICODE_80FD]"""
        self.equipment_system.equip_item(
            self.equipment_set, self.test_weapon, EquipmentSlot.WEAPON
        )
        self.equipment_system.equip_item(
            self.equipment_set, self.test_accessory, EquipmentSlot.ACCESSORY
        )
        
        breakdown = self.equipment_system.get_stat_breakdown(self.equipment_set)
        
        self.assertIn("by_item", breakdown)
        self.assertIn("by_stat", breakdown)
        self.assertIn("efficiency_contribution", breakdown)
        
        # [UNICODE_30A2]
        self.assertIn("weapon", breakdown["by_item"])
        self.assertIn("accessory", breakdown["by_item"])
        
        # [UNICODE_80FD]
        self.assertEqual(breakdown["by_stat"]["focus"], 5)  # weapon[UNICODE_304B]
        self.assertEqual(breakdown["by_stat"]["wisdom"], 8)  # accessory[UNICODE_304B]
        self.assertEqual(breakdown["by_stat"]["creativity"], 6)  # accessory[UNICODE_304B]
        
        # [UNICODE_52B9]
        focus_contribution = breakdown["efficiency_contribution"]["focus"]
        self.assertEqual(focus_contribution["stat_points"], 5)
        self.assertAlmostEqual(focus_contribution["efficiency_bonus"], 5 * 0.02, places=3)


class TestEquipmentSystemIntegration(unittest.TestCase):
    """[UNICODE_88C5]"""
    
    def setUp(self):
        """[UNICODE_30C6]"""
        self.equipment_system = EquipmentSystem()
        self.gacha_system = GachaSystem()
    
    def test_gacha_to_equipment_workflow(self):
        """[UNICODE_30AC]"""
        # [UNICODE_30AC]
        gacha_result = self.gacha_system.perform_gacha("ten_pull", 10000)
        self.assertTrue(gacha_result.success)
        
        equipment_set = EquipmentSet()
        equipped_items = []
        
        # [UNICODE_53D6]
        for item in gacha_result.items:
            for slot in EquipmentSlot:
                allowed_types = self.equipment_system.slot_item_types[slot]
                if item.item_type in allowed_types and equipment_set.get_item_by_slot(slot) is None:
                    success, message = self.equipment_system.equip_item(equipment_set, item, slot)
                    if success:
                        equipped_items.append(item)
                        break
        
        # [UNICODE_88C5]
        summary = self.equipment_system.get_equipment_summary(equipment_set)
        
        self.assertGreater(summary["total_equipped"], 0)
        self.assertGreaterEqual(summary["completion_bonus"]["total_bonus"], 0)
        
        print(f"[UNICODE_30AC]:")
        print(f"  [UNICODE_53D6]: {len(gacha_result.items)}")
        print(f"  [UNICODE_88C5]: {summary['total_equipped']}")
        print(f"  [UNICODE_4F5C]: {summary['completion_bonus']['bonus_percentage']}")
    
    def test_equipment_upgrade_recommendations(self):
        """[UNICODE_88C5]"""
        # [UNICODE_521D]
        equipment_set = EquipmentSet()
        
        # [UNICODE_4F4E]
        low_weapon = self._create_test_item(
            "[UNICODE_521D]", ItemType.WEAPON, ItemRarity.COMMON,
            {"focus": 1}, []
        )
        self.equipment_system.equip_item(equipment_set, low_weapon, EquipmentSlot.WEAPON)
        
        # [UNICODE_3088]
        available_items = [
            self._create_test_item(
                "[UNICODE_4E0A]", ItemType.WEAPON, ItemRarity.RARE,
                {"focus": 6, "motivation": 4}, ["task_focus_boost"]
            ),
            self._create_test_item(
                "[UNICODE_30DE]", ItemType.WEAPON, ItemRarity.LEGENDARY,
                {"focus": 15, "motivation": 10}, ["deep_work_mode", "motivation_boost"]
            ),
            self._create_test_item(
                "[UNICODE_9B54]", ItemType.ARMOR, ItemRarity.EPIC,
                {"resilience": 8, "social": 5}, ["productivity_enhance"]
            )
        ]
        
        recommendations = self.equipment_system.recommend_equipment_upgrade(
            equipment_set, available_items
        )
        
        self.assertGreater(len(recommendations), 0)
        
        # [UNICODE_6700]LEGENDARY[UNICODE_30A2]
        best_recommendation = recommendations[0]
        self.assertEqual(best_recommendation["item"].rarity, ItemRarity.LEGENDARY)
        self.assertGreater(best_recommendation["improvement"], 0)
        
        print(f"[UNICODE_30A2]:")
        for i, rec in enumerate(recommendations[:3]):
            print(f"  {i+1}. {rec['item'].name} ({rec['item'].rarity.value})")
            print(f"     [UNICODE_6539]: {rec['improvement_percentage']}")
            print(f"     [UNICODE_512A]: {rec['priority']}")
    
    def _create_test_item(self, name: str, item_type: ItemType, rarity: ItemRarity,
                         stat_bonuses: dict, special_effects: list) -> Item:
        """[UNICODE_30C6]"""
        return Item(
            id=f"test_{name}",
            name=name,
            description=f"{name}[UNICODE_306E]",
            rarity=rarity,
            item_type=item_type,
            therapeutic_theme=TherapeuticTheme.FOCUS,
            stat_bonuses=stat_bonuses,
            special_effects=special_effects,
            flavor_text=f"{name}[UNICODE_306E]",
            created_at=datetime.now()
        )
    
    def test_full_equipment_optimization(self):
        """[UNICODE_5B8C]"""
        # [UNICODE_5927]
        all_items = []
        for _ in range(50):
            gacha_result = self.gacha_system.perform_gacha("single", 10000)
            if gacha_result.success:
                all_items.extend(gacha_result.items)
        
        equipment_set = EquipmentSet()
        
        # [UNICODE_5404]
        for slot in EquipmentSlot:
            allowed_types = self.equipment_system.slot_item_types[slot]
            compatible_items = [item for item in all_items if item.item_type in allowed_types]
            
            if compatible_items:
                # [UNICODE_6700]
                best_item = max(compatible_items, 
                              key=lambda x: sum(x.stat_bonuses.values()))
                self.equipment_system.equip_item(equipment_set, best_item, slot)
        
        # [UNICODE_6700]
        summary = self.equipment_system.get_equipment_summary(equipment_set)
        breakdown = self.equipment_system.get_stat_breakdown(equipment_set)
        
        self.assertEqual(summary["total_equipped"], 6)  # [UNICODE_5168]
        self.assertGreater(summary["equipment_power"], 0)
        
        print(f"[UNICODE_5B8C]:")
        print(f"  [UNICODE_88C5]: {summary['equipment_power']}")
        print(f"  [UNICODE_4F5C]: {summary['completion_bonus']['bonus_percentage']}")
        print(f"  [UNICODE_30A2]: {len(summary['completion_bonus']['active_effects'])}")
        
        # [UNICODE_5404]
        print(f"  [UNICODE_80FD]:")
        for stat, contribution in breakdown["efficiency_contribution"].items():
            if contribution["stat_points"] > 0:
                print(f"    {stat}: {contribution['stat_points']}pt [UNICODE_2192] {contribution['percentage']}")


if __name__ == "__main__":
    # [UNICODE_30C6]
    unittest.main(verbosity=2)