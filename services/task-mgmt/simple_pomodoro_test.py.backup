"""
Pomodoro[UNICODE_7D71]

Requirements: 3.2, 5.3
"""

import sys
import os
import asyncio
from datetime import datetime, timedelta

# [UNICODE_30D7]
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from pomodoro_integration import (
    PomodoroIntegrationService, PomodoroSessionStatus, BreakType
)


async def test_pomodoro_basic_flow():
    """Pomodoro[UNICODE_57FA]"""
    print("=== Pomodoro[UNICODE_57FA] ===")
    
    service = PomodoroIntegrationService()
    uid = "test_user_123"
    task_id = "task_test_123"
    
    try:
        # 1. Pomodoro[UNICODE_30BB]
        print("1. Pomodoro[UNICODE_30BB]...")
        session = await service.start_pomodoro_session(
            uid=uid,
            task_id=task_id,
            duration=25,
            focus_music_enabled=True
        )
        
        assert session.status == PomodoroSessionStatus.ACTIVE
        assert session.planned_duration == 25
        assert session.focus_music_enabled is True
        print(f"   [UNICODE_2713] [UNICODE_30BB]: {session.session_id}")
        
        # 2. Pomodoro[UNICODE_30BB]
        print("2. Pomodoro[UNICODE_30BB]...")
        completed_session = await service.complete_pomodoro_session(
            session_id=session.session_id,
            actual_duration=23,
            notes="[UNICODE_96C6]"
        )
        
        assert completed_session.status == PomodoroSessionStatus.COMPLETED
        assert completed_session.actual_duration == 23
        print("   [UNICODE_2713] [UNICODE_30BB]")
        
        # 3. ADHD[UNICODE_652F]
        print("3. ADHD[UNICODE_652F]...")
        multiplier = service.calculate_adhd_assist_multiplier(uid)
        assert 1.0 <= multiplier <= 1.3
        print(f"   [UNICODE_2713] ADHD[UNICODE_652F]: {multiplier}")
        
        # 4. [UNICODE_7D71]
        print("4. [UNICODE_7D71]...")
        stats = await service.get_user_pomodoro_statistics(uid, 30)
        assert stats["total_sessions"] == 1
        assert stats["completed_sessions"] == 1
        assert stats["completion_rate"] == 1.0
        print(f"   [UNICODE_2713] [UNICODE_7D71]: {stats['total_sessions']}[UNICODE_30BB]")
        
        print("[UNICODE_2705] Pomodoro[UNICODE_57FA]")
        return True
        
    except Exception as e:
        print(f"[UNICODE_274C] Pomodoro[UNICODE_57FA]: {str(e)}")
        return False


async def test_continuous_work_monitoring():
    """[UNICODE_9023]3.2[UNICODE_FF09]"""
    print("\n=== [UNICODE_9023] ===")
    
    service = PomodoroIntegrationService()
    uid = "test_user_456"
    
    try:
        # 60[UNICODE_5206]
        print("1. 60[UNICODE_5206]...")
        past_time = datetime.utcnow() - timedelta(minutes=65)
        from pomodoro_integration import WorkSession
        
        service.work_sessions[uid] = WorkSession(
            uid=uid,
            start_time=past_time,
            is_active=True
        )
        
        # [UNICODE_9023]
        print("2. [UNICODE_9023]...")
        work_check = await service.check_continuous_work_time(uid)
        
        assert work_check["continuous_minutes"] >= 60
        assert work_check["needs_break"] is True
        assert work_check["break_suggestion"] is not None
        print(f"   [UNICODE_2713] [UNICODE_9023]: {work_check['continuous_minutes']}[UNICODE_5206]")
        print(f"   [UNICODE_2713] [UNICODE_4F11]: {work_check['break_suggestion']['type']}")
        
        # [UNICODE_4F11]1[UNICODE_56DE]
        print("3. [UNICODE_4F11]1[UNICODE_56DE]...")
        refusal1 = await service.handle_break_refusal(uid)
        assert refusal1["refusal_count"] == 1
        assert refusal1["show_mother_concern"] is False
        print("   [UNICODE_2713] 1[UNICODE_56DE]")
        
        # [UNICODE_4F11]2[UNICODE_56DE]
        print("4. [UNICODE_4F11]2[UNICODE_56DE]...")
        refusal2 = await service.handle_break_refusal(uid)
        assert refusal2["refusal_count"] == 2
        assert refusal2["show_mother_concern"] is True
        assert refusal2["mandatory_break_required"] is True
        assert "[UNICODE_304A]" in refusal2["narrative"]
        print("   [UNICODE_2713] [UNICODE_6BCD]")
        
        print("[UNICODE_2705] [UNICODE_9023]")
        return True
        
    except Exception as e:
        print(f"[UNICODE_274C] [UNICODE_9023]: {str(e)}")
        return False


async def test_adhd_assist_multiplier_calculation():
    """ADHD[UNICODE_652F]5.3[UNICODE_FF09]"""
    print("\n=== ADHD[UNICODE_652F] ===")
    
    service = PomodoroIntegrationService()
    uid = "test_user_789"
    
    try:
        # [UNICODE_521D]
        print("1. [UNICODE_521D]ADHD[UNICODE_652F]...")
        multiplier_initial = service.calculate_adhd_assist_multiplier(uid)
        assert multiplier_initial == 1.0
        print(f"   [UNICODE_2713] [UNICODE_521D]: {multiplier_initial}")
        
        # [UNICODE_30C6]
        print("2. [UNICODE_4F7F]...")
        from pomodoro_integration import ADHDSupportMetrics
        
        service.adhd_metrics[uid] = ADHDSupportMetrics(
            uid=uid,
            total_pomodoro_sessions=20,
            successful_sessions=18,
            usage_frequency_score=0.8,  # [UNICODE_9AD8]
            break_compliance_rate=0.9   # [UNICODE_9AD8]
        )
        
        # [UNICODE_4F7F]
        print("3. [UNICODE_4F7F]...")
        multiplier_with_data = service.calculate_adhd_assist_multiplier(uid)
        assert multiplier_with_data > multiplier_initial
        assert 1.2 <= multiplier_with_data <= 1.3
        print(f"   [UNICODE_2713] [UNICODE_4F7F]: {multiplier_with_data}")
        
        # [UNICODE_8907]
        print("4. [UNICODE_30BB]...")
        task_id = "task_test_789"
        
        # 3[UNICODE_3064]
        for i in range(3):
            session = await service.start_pomodoro_session(uid, f"{task_id}_{i}")
            await service.complete_pomodoro_session(session.session_id)
        
        # [UNICODE_4FC2]
        multiplier_after_sessions = service.calculate_adhd_assist_multiplier(uid)
        print(f"   [UNICODE_2713] [UNICODE_30BB]: {multiplier_after_sessions}")
        
        print("[UNICODE_2705] ADHD[UNICODE_652F]")
        return True
        
    except Exception as e:
        print(f"[UNICODE_274C] ADHD[UNICODE_652F]: {str(e)}")
        return False


async def test_break_management():
    """[UNICODE_4F11]"""
    print("\n=== [UNICODE_4F11] ===")
    
    service = PomodoroIntegrationService()
    uid = "test_user_break"
    task_id = "task_break_test"
    
    try:
        # [UNICODE_30BB]
        print("1. Pomodoro[UNICODE_30BB]...")
        session = await service.start_pomodoro_session(uid, task_id)
        await service.complete_pomodoro_session(session.session_id)
        
        # [UNICODE_77ED]
        print("2. [UNICODE_77ED]...")
        break_session = await service.start_break(
            session_id=session.session_id,
            break_type=BreakType.SHORT
        )
        
        assert break_session.status == PomodoroSessionStatus.BREAK
        assert break_session.break_type == BreakType.SHORT
        assert break_session.break_duration == 5
        print("   [UNICODE_2713] [UNICODE_77ED]")
        
        # [UNICODE_4F11]
        print("3. [UNICODE_4F11]...")
        completed_break = await service.complete_break(session.session_id)
        assert completed_break.status == PomodoroSessionStatus.COMPLETED
        print("   [UNICODE_2713] [UNICODE_4F11]")
        
        # [UNICODE_5F37]
        print("4. [UNICODE_5F37]...")
        session2 = await service.start_pomodoro_session(uid, task_id)
        await service.complete_pomodoro_session(session2.session_id)
        
        mandatory_break = await service.start_break(
            session_id=session2.session_id,
            break_type=BreakType.MANDATORY
        )
        
        assert mandatory_break.break_type == BreakType.MANDATORY
        assert mandatory_break.break_duration == 15
        print("   [UNICODE_2713] [UNICODE_5F37]")
        
        print("[UNICODE_2705] [UNICODE_4F11]")
        return True
        
    except Exception as e:
        print(f"[UNICODE_274C] [UNICODE_4F11]: {str(e)}")
        return False


async def main():
    """[UNICODE_30E1]"""
    print("[UNICODE_1F680] Pomodoro[UNICODE_7D71]ADHD[UNICODE_652F]")
    print("=" * 50)
    
    tests = [
        test_pomodoro_basic_flow,
        test_continuous_work_monitoring,
        test_adhd_assist_multiplier_calculation,
        test_break_management
    ]
    
    results = []
    for test in tests:
        result = await test()
        results.append(result)
    
    print("\n" + "=" * 50)
    print("[UNICODE_1F4CA] [UNICODE_30C6]")
    print(f"[UNICODE_6210]: {sum(results)}/{len(results)}")
    
    if all(results):
        print("[UNICODE_1F389] [UNICODE_5168]")
        print("\n[UNICODE_5B9F]:")
        print("[UNICODE_2713] Pomodoro[UNICODE_30BB]")
        print("[UNICODE_2713] ADHD[UNICODE_652F]")
        print("[UNICODE_2713] 60[UNICODE_5206]")
        print("[UNICODE_2713] 2[UNICODE_56DE]")
        print("[UNICODE_2713] [UNICODE_4F11]")
        print("[UNICODE_2713] [UNICODE_9023]")
        print("[UNICODE_2713] [UNICODE_7D71]")
        return True
    else:
        print("[UNICODE_274C] [UNICODE_4E00]")
        return False


if __name__ == "__main__":
    success = asyncio.run(main())
    exit(0 if success else 1)