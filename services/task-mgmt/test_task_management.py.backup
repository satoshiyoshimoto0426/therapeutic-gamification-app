"""
Task Management Service Tests

[UNICODE_30BF]

Requirements: 5.1, 5.5
"""

import pytest
import sys
import os
from fastapi.testclient import TestClient
from datetime import datetime, timedelta

# Add project root to path for imports
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from services.task_mgmt.main import app
from shared.interfaces.task_system import TaskType, TaskDifficulty, TaskPriority, TaskStatus, ADHDSupportLevel
from shared.interfaces.core_types import CrystalAttribute


class TestTaskManagementService:
    """[UNICODE_30BF]"""
    
    def setup_method(self):
        """[UNICODE_30C6]"""
        self.client = TestClient(app)
        self.test_uid = "test_user_001"
    
    def test_health_check(self):
        """[UNICODE_30D8]"""
        response = self.client.get("/health")
        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "healthy"
        assert data["service"] == "task-mgmt"
    
    def test_create_routine_task(self):
        """[UNICODE_30EB]"""
        task_request = {
            "task_type": TaskType.ROUTINE.value,
            "title": "[UNICODE_671D]",
            "description": "[UNICODE_6BCE]30[UNICODE_5206]",
            "difficulty": TaskDifficulty.EASY.value,
            "priority": TaskPriority.HIGH.value,
            "estimated_duration": 30,
            "adhd_support_level": ADHDSupportLevel.BASIC.value,
            "pomodoro_sessions_planned": 1,
            "break_reminders_enabled": True,
            "tags": ["[UNICODE_5065]", "[UNICODE_7FD2]"],
            "is_recurring": True,
            "recurrence_pattern": "daily"
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_type"] == TaskType.ROUTINE.value
        assert data["title"] == "[UNICODE_671D]"
        assert data["difficulty"] == TaskDifficulty.EASY.value
        assert data["status"] == TaskStatus.PENDING.value
        assert data["base_xp"] > 0  # [UNICODE_30EB]XP[UNICODE_304C]
        assert data["primary_crystal_attribute"] == CrystalAttribute.SELF_DISCIPLINE.value  # [UNICODE_81EA]
        assert data["is_recurring"] is True
        
        return data["task_id"]
    
    def test_create_one_shot_task(self):
        """[UNICODE_5358]"""
        task_request = {
            "task_type": TaskType.ONE_SHOT.value,
            "title": "[UNICODE_30D7]",
            "description": "[UNICODE_6765]",
            "difficulty": TaskDifficulty.HARD.value,
            "priority": TaskPriority.URGENT.value,
            "estimated_duration": 120,
            "due_date": (datetime.utcnow() + timedelta(days=7)).isoformat(),
            "adhd_support_level": ADHDSupportLevel.MODERATE.value,
            "pomodoro_sessions_planned": 4,
            "primary_crystal_attribute": CrystalAttribute.COURAGE.value,
            "tags": ["[UNICODE_4ED5]", "[UNICODE_91CD]"]
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_type"] == TaskType.ONE_SHOT.value
        assert data["title"] == "[UNICODE_30D7]"
        assert data["difficulty"] == TaskDifficulty.HARD.value
        assert data["priority"] == TaskPriority.URGENT.value
        assert data["due_date"] is not None
        assert data["primary_crystal_attribute"] == CrystalAttribute.COURAGE.value
        
        return data["task_id"]
    
    def test_create_skill_up_task(self):
        """[UNICODE_30B9]"""
        task_request = {
            "task_type": TaskType.SKILL_UP.value,
            "title": "Python[UNICODE_5B66]",
            "description": "Python[UNICODE_306E]",
            "difficulty": TaskDifficulty.MEDIUM.value,
            "estimated_duration": 60,
            "adhd_support_level": ADHDSupportLevel.INTENSIVE.value,
            "pomodoro_sessions_planned": 2,
            "focus_music_enabled": True,
            "tags": ["[UNICODE_5B66]", "[UNICODE_30D7]"]
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_type"] == TaskType.SKILL_UP.value
        assert data["title"] == "Python[UNICODE_5B66]"
        assert data["adhd_support_level"] == ADHDSupportLevel.INTENSIVE.value
        assert data["focus_music_enabled"] is True
        assert data["primary_crystal_attribute"] == CrystalAttribute.WISDOM.value  # [UNICODE_81EA]
        
        return data["task_id"]
    
    def test_create_social_task(self):
        """[UNICODE_793E]"""
        task_request = {
            "task_type": TaskType.SOCIAL.value,
            "title": "[UNICODE_53CB]",
            "description": "[UNICODE_4E45]",
            "difficulty": TaskDifficulty.EASY.value,
            "estimated_duration": 45,
            "primary_crystal_attribute": CrystalAttribute.COMMUNICATION.value,
            "secondary_crystal_attributes": [CrystalAttribute.EMPATHY.value],
            "tags": ["[UNICODE_793E]", "[UNICODE_53CB]"]
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_type"] == TaskType.SOCIAL.value
        assert data["title"] == "[UNICODE_53CB]"
        assert data["primary_crystal_attribute"] == CrystalAttribute.COMMUNICATION.value
        assert CrystalAttribute.EMPATHY.value in data["secondary_crystal_attributes"]
        
        return data["task_id"]
    
    def test_daily_task_limit(self):
        """[UNICODE_65E5]"""
        # 16[UNICODE_500B]
        for i in range(16):
            task_request = {
                "task_type": TaskType.ROUTINE.value,
                "title": f"[UNICODE_30C6]{i+1}",
                "description": f"[UNICODE_5236]{i+1}",
                "difficulty": TaskDifficulty.EASY.value
            }
            
            response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
            assert response.status_code == 200
        
        # 17[UNICODE_500B]
        task_request = {
            "task_type": TaskType.ROUTINE.value,
            "title": "[UNICODE_5236]",
            "description": "17[UNICODE_500B]",
            "difficulty": TaskDifficulty.EASY.value
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/create", json=task_request)
        assert response.status_code == 429  # Too Many Requests
        assert "Daily task limit exceeded" in response.json()["detail"]
    
    def test_get_user_tasks(self):
        """[UNICODE_30E6]"""
        # [UNICODE_3044]
        task_ids = []
        for i in range(3):
            task_id = self.test_create_routine_task()
            task_ids.append(task_id)
        
        # [UNICODE_30BF]
        response = self.client.get(f"/tasks/{self.test_uid}")
        assert response.status_code == 200
        
        data = response.json()
        assert len(data) >= 3
        
        # [UNICODE_4F5C]
        returned_task_ids = [task["task_id"] for task in data]
        for task_id in task_ids:
            assert task_id in returned_task_ids
    
    def test_get_task_by_id(self):
        """[UNICODE_30BF]ID[UNICODE_6307]"""
        # [UNICODE_30BF]
        task_id = self.test_create_skill_up_task()
        
        # [UNICODE_30BF]
        response = self.client.get(f"/tasks/{self.test_uid}/{task_id}")
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_id"] == task_id
        assert data["task_type"] == TaskType.SKILL_UP.value
        assert data["title"] == "Python[UNICODE_5B66]"
    
    def test_update_task(self):
        """[UNICODE_30BF]"""
        # [UNICODE_30BF]
        task_id = self.test_create_one_shot_task()
        
        # [UNICODE_30BF]
        update_request = {
            "title": "[UNICODE_66F4]",
            "description": "[UNICODE_66F4]",
            "priority": TaskPriority.HIGH.value,
            "notes": "[UNICODE_66F4]"
        }
        
        response = self.client.put(f"/tasks/{self.test_uid}/{task_id}", json=update_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["title"] == "[UNICODE_66F4]"
        assert data["description"] == "[UNICODE_66F4]"
        assert data["priority"] == TaskPriority.HIGH.value
        assert data["notes"] == "[UNICODE_66F4]"
    
    def test_start_task(self):
        """[UNICODE_30BF]"""
        # [UNICODE_30BF]
        task_id = self.test_create_routine_task()
        
        # [UNICODE_30BF]
        start_request = {
            "pomodoro_session": True
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/start", json=start_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["status"] == TaskStatus.IN_PROGRESS.value
        assert data["started_at"] is not None
    
    def test_complete_task_with_xp_calculation(self):
        """[UNICODE_30BF]XP[UNICODE_8A08]"""
        # [UNICODE_30BF]
        task_id = self.test_create_skill_up_task()
        
        # [UNICODE_30BF]
        start_request = {"pomodoro_session": True}
        start_response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/start", json=start_request)
        assert start_response.status_code == 200
        
        # [UNICODE_30BF]
        complete_request = {
            "mood_score": 4,
            "actual_duration": 55,
            "notes": "[UNICODE_5B66]",
            "pomodoro_sessions_completed": 2
        }
        
        response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/complete", json=complete_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["success"] is True
        assert data["task"]["status"] == TaskStatus.COMPLETED.value
        assert data["task"]["completed_at"] is not None
        assert data["task"]["mood_at_completion"] == 4
        assert data["task"]["actual_duration"] == 55
        assert data["task"]["notes"] == "[UNICODE_5B66]"
        
        # XP[UNICODE_8A08]
        assert data["xp_earned"] > 0
        assert "xp_calculation" in data
        xp_calc = data["xp_calculation"]
        assert xp_calc["base_xp"] > 0
        assert 0.8 <= xp_calc["mood_coefficient"] <= 1.2
        assert 1.0 <= xp_calc["adhd_assist_multiplier"] <= 1.5
        assert xp_calc["final_xp"] > 0
        
        # [UNICODE_30AF]
        assert "crystal_growth_events" in data
        assert len(data["crystal_growth_events"]) > 0
    
    def test_delete_task(self):
        """[UNICODE_30BF]"""
        # [UNICODE_30BF]
        task_id = self.test_create_routine_task()
        
        # [UNICODE_30BF]
        response = self.client.delete(f"/tasks/{self.test_uid}/{task_id}")
        assert response.status_code == 200
        
        data = response.json()
        assert data["success"] is True
        assert data["task_id"] == task_id
        
        # [UNICODE_524A]
        get_response = self.client.get(f"/tasks/{self.test_uid}/{task_id}")
        assert get_response.status_code == 404
    
    def test_xp_preview(self):
        """XP[UNICODE_30D7]"""
        preview_request = {
            "task_type": TaskType.SKILL_UP.value,
            "difficulty": TaskDifficulty.HARD.value,
            "mood_score": 5,
            "adhd_support_level": ADHDSupportLevel.INTENSIVE.value
        }
        
        response = self.client.post("/tasks/xp-preview", json=preview_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["task_type"] == TaskType.SKILL_UP.value
        assert data["difficulty"] == TaskDifficulty.HARD.value
        assert data["mood_score"] == 5
        assert data["estimated_xp"] > 0
    
    def test_task_recommendations(self):
        """[UNICODE_30BF]"""
        recommendation_request = {
            "primary_goal": "[UNICODE_30D7]",
            "user_experience_level": 3,
            "task_complexity": "moderate",
            "user_confidence": 4
        }
        
        response = self.client.post("/tasks/recommendations", json=recommendation_request)
        assert response.status_code == 200
        
        data = response.json()
        assert data["primary_goal"] == "[UNICODE_30D7]"
        assert data["recommended_task_type"] == TaskType.SKILL_UP.value  # "[UNICODE_30B9]"[UNICODE_30AD]
        assert data["recommended_difficulty"] in [d.value for d in TaskDifficulty]
        assert len(data["recommended_crystals"]) > 0
        assert "reasoning" in data
    
    def test_task_statistics(self):
        """[UNICODE_30BF]"""
        # [UNICODE_3044]
        task_ids = []
        for i in range(5):
            task_id = self.test_create_routine_task()
            task_ids.append(task_id)
        
        # [UNICODE_3044]
        for task_id in task_ids[:3]:
            # [UNICODE_958B]
            start_response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/start", json={})
            assert start_response.status_code == 200
            
            # [UNICODE_5B8C]
            complete_request = {
                "mood_score": 3,
                "actual_duration": 25,
                "notes": "[UNICODE_5B8C]"
            }
            complete_response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/complete", json=complete_request)
            assert complete_response.status_code == 200
        
        # [UNICODE_7D71]
        response = self.client.get(f"/tasks/{self.test_uid}/statistics?days=30")
        assert response.status_code == 200
        
        data = response.json()
        assert data["total_tasks"] >= 5
        assert data["completed_tasks"] >= 3
        assert data["completion_rate"] > 0
        assert data["total_xp_earned"] > 0
        assert "task_type_statistics" in data
        assert "difficulty_statistics" in data
    
    def test_daily_summary(self):
        """[UNICODE_65E5]"""
        # [UNICODE_4ECA]
        task_ids = []
        for i in range(3):
            task_id = self.test_create_routine_task()
            task_ids.append(task_id)
        
        # 1[UNICODE_3064]
        task_id = task_ids[0]
        start_response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/start", json={})
        assert start_response.status_code == 200
        
        complete_request = {
            "mood_score": 4,
            "actual_duration": 30,
            "notes": "[UNICODE_5B8C]"
        }
        complete_response = self.client.post(f"/tasks/{self.test_uid}/{task_id}/complete", json=complete_request)
        assert complete_response.status_code == 200
        
        # [UNICODE_65E5]
        response = self.client.get(f"/tasks/{self.test_uid}/daily-summary")
        assert response.status_code == 200
        
        data = response.json()
        assert data["total_tasks"] >= 3
        assert data["completed_tasks"] >= 1
        assert data["daily_xp_earned"] > 0
        assert data["remaining_task_slots"] <= 16
        assert "task_type_completion" in data
    
    def test_task_filtering(self):
        """[UNICODE_30BF]"""
        # [UNICODE_7570]
        routine_id = self.test_create_routine_task()
        skill_up_id = self.test_create_skill_up_task()
        
        # [UNICODE_30EB]
        response = self.client.get(f"/tasks/{self.test_uid}?task_type={TaskType.ROUTINE.value}")
        assert response.status_code == 200
        
        data = response.json()
        for task in data:
            assert task["task_type"] == TaskType.ROUTINE.value
        
        # [UNICODE_30B9]
        response = self.client.get(f"/tasks/{self.test_uid}?task_type={TaskType.SKILL_UP.value}")
        assert response.status_code == 200
        
        data = response.json()
        for task in data:
            assert task["task_type"] == TaskType.SKILL_UP.value


if __name__ == "__main__":
    pytest.main([__file__, "-v"])