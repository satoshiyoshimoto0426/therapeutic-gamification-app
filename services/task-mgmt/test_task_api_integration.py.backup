"""
[UNICODE_30BF]API[UNICODE_30A8]

Task 6.3: [UNICODE_30BF]API[UNICODE_30A8]
- [UNICODE_30BF]CRUD[UNICODE_64CD]API[UNICODE_3092]
- [UNICODE_65E5]16[UNICODE_30BF]
- [UNICODE_30BF]XP[UNICODE_4ED8]API[UNICODE_3092]
- [UNICODE_30BF]API[UNICODE_306E]

Requirements: 3.4, 5.1
"""

import pytest
import asyncio
from fastapi.testclient import TestClient
from datetime import datetime, timedelta
import sys
import os

# Add project root to path for imports
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

from main import app
from shared.interfaces.task_system import TaskType, TaskDifficulty, TaskPriority, TaskStatus, ADHDSupportLevel
from shared.interfaces.core_types import CrystalAttribute

client = TestClient(app)

class TestTaskCRUDOperations:
    """[UNICODE_30BF]CRUD[UNICODE_64CD]"""
    
    def test_create_task_success(self):
        """[UNICODE_30BF]"""
        uid = "test_user_001"
        task_data = {
            "task_type": "routine",
            "title": "[UNICODE_671D]",
            "description": "30[UNICODE_5206]",
            "difficulty": 2,
            "priority": "medium",
            "estimated_duration": 30,
            "adhd_support_level": "basic",
            "pomodoro_sessions_planned": 1,
            "break_reminders_enabled": True,
            "focus_music_enabled": False,
            "tags": ["[UNICODE_5065]", "[UNICODE_904B]"],
            "is_recurring": True,
            "recurrence_pattern": "daily"
        }
        
        response = client.post(f"/tasks/{uid}/create", json=task_data)
        
        assert response.status_code == 200
        data = response.json()
        
        assert data["uid"] == uid
        assert data["task_type"] == "routine"
        assert data["title"] == "[UNICODE_671D]"
        assert data["description"] == "30[UNICODE_5206]"
        assert data["difficulty"] == 2
        assert data["priority"] == "medium"
        assert data["status"] == "pending"
        assert data["estimated_duration"] == 30
        assert data["adhd_support_level"] == "basic"
        assert data["pomodoro_sessions_planned"] == 1
        assert data["break_reminders_enabled"] is True
        assert data["focus_music_enabled"] is False
        assert data["tags"] == ["[UNICODE_5065]", "[UNICODE_904B]"]
        assert data["is_recurring"] is True
        assert data["recurrence_pattern"] == "daily"
        assert data["base_xp"] > 0
        assert data["xp_earned"] == 0  # [UNICODE_672A]XP[UNICODE_306F]0
        assert data["is_overdue"] is False
    
    def test_get_user_tasks(self):
        """[UNICODE_30E6]"""
        uid = "test_user_002"
        
        # [UNICODE_8907]
        task_types = ["routine", "one_shot", "skill_up", "social"]
        created_tasks = []
        
        for i, task_type in enumerate(task_types):
            task_data = {
                "task_type": task_type,
                "title": f"[UNICODE_30C6]{i+1}",
                "description": f"{task_type}[UNICODE_30BF]",
                "difficulty": (i % 3) + 1,
                "priority": "medium",
                "estimated_duration": 30
            }
            
            response = client.post(f"/tasks/{uid}/create", json=task_data)
            assert response.status_code == 200
            created_tasks.append(response.json())
        
        # [UNICODE_30BF]
        response = client.get(f"/tasks/{uid}")
        
        assert response.status_code == 200
        tasks = response.json()
        
        assert len(tasks) == 4
        
        # [UNICODE_30BF]
        response = client.get(f"/tasks/{uid}?task_type=routine")
        assert response.status_code == 200
        routine_tasks = response.json()
        assert len(routine_tasks) == 1
        assert routine_tasks[0]["task_type"] == "routine"
    
    def test_get_specific_task(self):
        """[UNICODE_7279]"""
        uid = "test_user_003"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "one_shot",
            "title": "[UNICODE_91CD]",
            "description": "[UNICODE_30D7]",
            "difficulty": 3,
            "priority": "high",
            "estimated_duration": 120
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        created_task = create_response.json()
        task_id = created_task["task_id"]
        
        # [UNICODE_7279]
        response = client.get(f"/tasks/{uid}/{task_id}")
        
        assert response.status_code == 200
        task = response.json()
        
        assert task["task_id"] == task_id
        assert task["title"] == "[UNICODE_91CD]"
        assert task["difficulty"] == 3
        assert task["priority"] == "high"
    
    def test_update_task(self):
        """[UNICODE_30BF]"""
        uid = "test_user_004"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "skill_up",
            "title": "Python[UNICODE_5B66]",
            "description": "[UNICODE_57FA]",
            "difficulty": 2,
            "priority": "medium",
            "estimated_duration": 60
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        created_task = create_response.json()
        task_id = created_task["task_id"]
        
        # [UNICODE_30BF]
        update_data = {
            "title": "Python[UNICODE_4E0A]",
            "description": "[UNICODE_30AA]",
            "difficulty": 4,
            "priority": "high",
            "estimated_duration": 90,
            "tags": ["[UNICODE_30D7]", "[UNICODE_30B9]"]
        }
        
        response = client.put(f"/tasks/{uid}/{task_id}", json=update_data)
        
        assert response.status_code == 200
        updated_task = response.json()
        
        assert updated_task["title"] == "Python[UNICODE_4E0A]"
        assert updated_task["description"] == "[UNICODE_30AA]"
        assert updated_task["difficulty"] == 4
        assert updated_task["priority"] == "high"
        assert updated_task["estimated_duration"] == 90
        assert updated_task["tags"] == ["[UNICODE_30D7]", "[UNICODE_30B9]"]
    
    def test_start_task(self):
        """[UNICODE_30BF]"""
        uid = "test_user_005"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "routine",
            "title": "[UNICODE_8AAD]",
            "description": "[UNICODE_6280]",
            "difficulty": 2,
            "priority": "medium",
            "estimated_duration": 45
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        created_task = create_response.json()
        task_id = created_task["task_id"]
        
        # [UNICODE_30BF]
        start_data = {
            "pomodoro_session": True
        }
        
        response = client.post(f"/tasks/{uid}/{task_id}/start", json=start_data)
        
        assert response.status_code == 200
        started_task = response.json()
        
        assert started_task["status"] == "in_progress"
        assert started_task["started_at"] is not None
    
    def test_complete_task_with_xp_calculation(self):
        """[UNICODE_30BF]XP[UNICODE_8A08]"""
        uid = "test_user_006"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "social",
            "title": "[UNICODE_53CB]",
            "description": "[UNICODE_4E45]",
            "difficulty": 3,
            "priority": "high",
            "estimated_duration": 120,
            "adhd_support_level": "enhanced"
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        created_task = create_response.json()
        task_id = created_task["task_id"]
        
        # [UNICODE_30BF]
        start_response = client.post(f"/tasks/{uid}/{task_id}/start", json={})
        assert start_response.status_code == 200
        
        # [UNICODE_30BF]
        complete_data = {
            "mood_score": 4,
            "actual_duration": 110,
            "notes": "[UNICODE_3068]",
            "pomodoro_sessions_completed": 2
        }
        
        response = client.post(f"/tasks/{uid}/{task_id}/complete", json=complete_data)
        
        assert response.status_code == 200
        result = response.json()
        
        assert result["success"] is True
        assert result["task"]["status"] == "completed"
        assert result["task"]["completed_at"] is not None
        assert result["task"]["mood_at_completion"] == 4
        assert result["task"]["actual_duration"] == 110
        assert result["task"]["notes"] == "[UNICODE_3068]"
        assert result["task"]["pomodoro_sessions_completed"] == 2
        
        # XP[UNICODE_8A08]
        assert result["xp_earned"] > 0
        assert "xp_calculation" in result
        xp_calc = result["xp_calculation"]
        assert xp_calc["base_xp"] > 0
        assert xp_calc["mood_coefficient"] > 0
        assert xp_calc["adhd_assist_multiplier"] >= 1.0
        assert xp_calc["final_xp"] > 0
        
        # Pomodoro[UNICODE_7D71]
        assert "pomodoro_integration" in result
        pomodoro_info = result["pomodoro_integration"]
        assert pomodoro_info["sessions_completed"] == 2
        assert pomodoro_info["adhd_assist_multiplier"] >= 1.0
    
    def test_delete_task(self):
        """[UNICODE_30BF]"""
        uid = "test_user_007"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "one_shot",
            "title": "[UNICODE_524A]",
            "description": "[UNICODE_3053]",
            "difficulty": 1,
            "priority": "low",
            "estimated_duration": 15
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        created_task = create_response.json()
        task_id = created_task["task_id"]
        
        # [UNICODE_30BF]
        response = client.delete(f"/tasks/{uid}/{task_id}")
        
        assert response.status_code == 200
        result = response.json()
        
        assert result["success"] is True
        assert result["task_id"] == task_id
        
        # [UNICODE_524A]
        get_response = client.get(f"/tasks/{uid}/{task_id}")
        assert get_response.status_code == 404


class TestDailyTaskLimit:
    """[UNICODE_65E5]16[UNICODE_30BF]"""
    
    def test_daily_task_limit_enforcement(self):
        """[UNICODE_65E5]"""
        uid = "test_user_limit"
        
        # 16[UNICODE_500B]
        for i in range(16):
            task_data = {
                "task_type": "routine",
                "title": f"[UNICODE_30BF]{i+1}",
                "description": f"[UNICODE_5236]{i+1}",
                "difficulty": 1,
                "priority": "low",
                "estimated_duration": 15
            }
            
            response = client.post(f"/tasks/{uid}/create", json=task_data)
            assert response.status_code == 200
        
        # 17[UNICODE_500B]
        task_data = {
            "task_type": "routine",
            "title": "[UNICODE_5236]",
            "description": "[UNICODE_3053]",
            "difficulty": 1,
            "priority": "low",
            "estimated_duration": 15
        }
        
        response = client.post(f"/tasks/{uid}/create", json=task_data)
        
        assert response.status_code == 429
        assert "Daily task limit exceeded" in response.json()["detail"]
    
    def test_daily_summary_with_limit_info(self):
        """[UNICODE_65E5]"""
        uid = "test_user_summary"
        
        # 10[UNICODE_500B]
        for i in range(10):
            task_data = {
                "task_type": "routine",
                "title": f"[UNICODE_30B5]{i+1}",
                "description": f"[UNICODE_30B5]{i+1}",
                "difficulty": 1,
                "priority": "medium",
                "estimated_duration": 20
            }
            
            response = client.post(f"/tasks/{uid}/create", json=task_data)
            assert response.status_code == 200
        
        # [UNICODE_65E5]
        response = client.get(f"/tasks/{uid}/daily-summary")
        
        assert response.status_code == 200
        summary = response.json()
        
        assert summary["total_tasks"] == 10
        assert summary["daily_limit"] == 16
        assert summary["remaining_slots"] == 6
        assert summary["limit_reached"] is False
        
        # [UNICODE_4ECA]
        today = datetime.utcnow().date().isoformat()
        assert summary["date"] == today


class TestTaskStatisticsAndAnalytics:
    """[UNICODE_30BF]"""
    
    def test_task_statistics(self):
        """[UNICODE_30BF]"""
        uid = "test_user_stats"
        
        # [UNICODE_69D8]
        task_configs = [
            {"type": "routine", "difficulty": 1, "complete": True, "mood": 4},
            {"type": "routine", "difficulty": 2, "complete": True, "mood": 3},
            {"type": "one_shot", "difficulty": 3, "complete": True, "mood": 5},
            {"type": "skill_up", "difficulty": 2, "complete": False, "mood": None},
            {"type": "social", "difficulty": 4, "complete": True, "mood": 4}
        ]
        
        for i, config in enumerate(task_configs):
            # [UNICODE_30BF]
            task_data = {
                "task_type": config["type"],
                "title": f"[UNICODE_7D71]{i+1}",
                "description": f"{config['type']}[UNICODE_30BF]",
                "difficulty": config["difficulty"],
                "priority": "medium",
                "estimated_duration": 30
            }
            
            create_response = client.post(f"/tasks/{uid}/create", json=task_data)
            assert create_response.status_code == 200
            task = create_response.json()
            task_id = task["task_id"]
            
            if config["complete"]:
                # [UNICODE_30BF]
                start_response = client.post(f"/tasks/{uid}/{task_id}/start", json={})
                assert start_response.status_code == 200
                
                # [UNICODE_30BF]
                complete_data = {
                    "mood_score": config["mood"],
                    "actual_duration": 25,
                    "notes": "[UNICODE_7D71]",
                    "pomodoro_sessions_completed": 1
                }
                
                complete_response = client.post(f"/tasks/{uid}/{task_id}/complete", json=complete_data)
                assert complete_response.status_code == 200
        
        # [UNICODE_7D71]
        response = client.get(f"/tasks/{uid}/statistics?days=30")
        
        assert response.status_code == 200
        stats = response.json()
        
        assert stats["total_tasks"] == 5
        assert stats["completed_tasks"] == 4
        assert stats["in_progress_tasks"] == 0
        assert stats["pending_tasks"] == 1
        assert stats["completion_rate"] == 0.8  # 4/5
        assert stats["total_xp_earned"] > 0
        assert stats["average_xp_per_task"] > 0
        
        # [UNICODE_30BF]
        type_stats = stats["task_type_statistics"]
        assert type_stats["routine"]["total"] == 2
        assert type_stats["routine"]["completed"] == 2
        assert type_stats["one_shot"]["total"] == 1
        assert type_stats["one_shot"]["completed"] == 1
        assert type_stats["skill_up"]["total"] == 1
        assert type_stats["skill_up"]["completed"] == 0
        assert type_stats["social"]["total"] == 1
        assert type_stats["social"]["completed"] == 1


class TestXPPreviewAndRecommendations:
    """XP[UNICODE_30D7]"""
    
    def test_xp_preview(self):
        """XP[UNICODE_30D7]"""
        preview_data = {
            "task_type": "skill_up",
            "difficulty": 3,
            "mood_score": 4,
            "adhd_support_level": "enhanced"
        }
        
        response = client.post("/tasks/xp-preview", json=preview_data)
        
        assert response.status_code == 200
        result = response.json()
        
        assert result["task_type"] == "skill_up"
        assert result["difficulty"] == 3
        assert result["mood_score"] == 4
        assert result["adhd_support_level"] == "enhanced"
        assert result["estimated_xp"] > 0
    
    def test_task_recommendations(self):
        """[UNICODE_30BF]"""
        recommendation_data = {
            "primary_goal": "[UNICODE_30D7]",
            "user_experience_level": 3,
            "task_complexity": "moderate",
            "user_confidence": 4
        }
        
        response = client.post("/tasks/recommendations", json=recommendation_data)
        
        assert response.status_code == 200
        result = response.json()
        
        assert result["primary_goal"] == "[UNICODE_30D7]"
        assert result["recommended_task_type"] in ["routine", "one_shot", "skill_up", "social"]
        assert result["recommended_difficulty"] in [1, 2, 3, 4, 5]
        assert isinstance(result["recommended_crystals"], list)
        assert "reasoning" in result
        assert "task_type_reason" in result["reasoning"]
        assert "difficulty_reason" in result["reasoning"]


class TestPomodoroIntegration:
    """Pomodoro[UNICODE_7D71]"""
    
    def test_pomodoro_session_lifecycle(self):
        """Pomodoro[UNICODE_30BB]"""
        uid = "test_user_pomodoro"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "skill_up",
            "title": "[UNICODE_96C6]",
            "description": "Pomodoro[UNICODE_30C6]",
            "difficulty": 3,
            "priority": "high",
            "estimated_duration": 50,
            "pomodoro_sessions_planned": 2
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        task = create_response.json()
        task_id = task["task_id"]
        
        # [UNICODE_30BF]
        start_response = client.post(f"/tasks/{uid}/{task_id}/start", json={})
        assert start_response.status_code == 200
        
        # Pomodoro[UNICODE_30BB]
        pomodoro_start_data = {
            "duration": 25,
            "focus_music_enabled": True
        }
        
        pomodoro_response = client.post(
            f"/tasks/{uid}/{task_id}/pomodoro/start", 
            json=pomodoro_start_data
        )
        
        assert pomodoro_response.status_code == 200
        session = pomodoro_response.json()
        
        assert session["uid"] == uid
        assert session["task_id"] == task_id
        assert session["planned_duration"] == 25
        assert session["focus_music_enabled"] is True
        assert session["status"] == "active"
        
        session_id = session["session_id"]
        
        # Pomodoro[UNICODE_30BB]
        pomodoro_complete_data = {
            "actual_duration": 23,
            "notes": "[UNICODE_96C6]"
        }
        
        complete_response = client.post(
            f"/tasks/{uid}/{task_id}/pomodoro/{session_id}/complete",
            json=pomodoro_complete_data
        )
        
        assert complete_response.status_code == 200
        result = complete_response.json()
        
        assert result["success"] is True
        assert result["session"]["status"] == "completed"
        assert result["session"]["actual_duration"] == 23
        assert result["session"]["notes"] == "[UNICODE_96C6]"
        
        # ADHD[UNICODE_652F]
        assert "adhd_support_metrics" in result
        metrics = result["adhd_support_metrics"]
        assert "usage_frequency_score" in metrics
        assert "break_compliance_rate" in metrics
        assert "adhd_assist_multiplier" in metrics
    
    def test_pomodoro_statistics(self):
        """Pomodoro[UNICODE_7D71]"""
        uid = "test_user_pomodoro_stats"
        
        response = client.get(f"/tasks/{uid}/pomodoro/statistics?days=7")
        
        assert response.status_code == 200
        stats = response.json()
        
        assert "period_days" in stats
        assert "total_sessions" in stats
        assert "completed_sessions" in stats
        assert "total_focus_time" in stats
        assert "average_session_duration" in stats
        assert "break_compliance_rate" in stats
        assert "usage_frequency_score" in stats
        assert "adhd_assist_multiplier" in stats
        assert "interruption_rate" in stats


class TestErrorHandling:
    """[UNICODE_30A8]"""
    
    def test_task_not_found(self):
        """[UNICODE_5B58]"""
        uid = "test_user_error"
        non_existent_task_id = "non_existent_task_123"
        
        response = client.get(f"/tasks/{uid}/{non_existent_task_id}")
        
        assert response.status_code == 404
        assert "Task not found" in response.json()["detail"]
    
    def test_invalid_task_data(self):
        """[UNICODE_7121]"""
        uid = "test_user_invalid"
        
        # [UNICODE_7121]
        invalid_task_data = {
            "task_type": "routine",
            "title": "[UNICODE_7121]",
            "description": "[UNICODE_7121]",
            "difficulty": 10,  # [UNICODE_7121]1-5[UNICODE_306E]
            "priority": "medium",
            "estimated_duration": 30
        }
        
        response = client.post(f"/tasks/{uid}/create", json=invalid_task_data)
        
        assert response.status_code == 422  # Validation error
    
    def test_complete_non_in_progress_task(self):
        """[UNICODE_9032]"""
        uid = "test_user_complete_error"
        
        # [UNICODE_30BF]
        task_data = {
            "task_type": "routine",
            "title": "[UNICODE_672A]",
            "description": "[UNICODE_958B]",
            "difficulty": 2,
            "priority": "medium",
            "estimated_duration": 30
        }
        
        create_response = client.post(f"/tasks/{uid}/create", json=task_data)
        assert create_response.status_code == 200
        task = create_response.json()
        task_id = task["task_id"]
        
        # [UNICODE_958B]
        complete_data = {
            "mood_score": 3,
            "actual_duration": 25,
            "notes": "[UNICODE_5B8C]",
            "pomodoro_sessions_completed": 0
        }
        
        response = client.post(f"/tasks/{uid}/{task_id}/complete", json=complete_data)
        
        assert response.status_code == 400
        assert "Task is not in progress" in response.json()["detail"]


def test_health_check():
    """[UNICODE_30D8]"""
    response = client.get("/health")
    
    assert response.status_code == 200
    health = response.json()
    
    assert health["status"] == "healthy"
    assert health["service"] == "task-management"
    assert health["version"] == "1.0.0"
    assert "timestamp" in health


if __name__ == "__main__":
    # [UNICODE_57FA]
    print("[UNICODE_30BF]API[UNICODE_7D71]...")
    
    # [UNICODE_30C6]
    test_uid = "integration_test_user"
    
    # 1. [UNICODE_30BF]
    print("1. [UNICODE_30BF]")
    task_data = {
        "task_type": "routine",
        "title": "[UNICODE_7D71]",
        "description": "API[UNICODE_7D71]",
        "difficulty": 2,
        "priority": "medium",
        "estimated_duration": 30
    }
    
    response = client.post(f"/tasks/{test_uid}/create", json=task_data)
    if response.status_code == 200:
        print("[UNICODE_2713] [UNICODE_30BF]")
        task = response.json()
        task_id = task["task_id"]
    else:
        print(f"[UNICODE_2717] [UNICODE_30BF]: {response.status_code}")
        exit(1)
    
    # 2. [UNICODE_30BF]
    print("2. [UNICODE_30BF]")
    response = client.get(f"/tasks/{test_uid}")
    if response.status_code == 200:
        tasks = response.json()
        print(f"[UNICODE_2713] [UNICODE_30BF]: {len(tasks)}[UNICODE_4EF6]")
    else:
        print(f"[UNICODE_2717] [UNICODE_30BF]: {response.status_code}")
    
    # 3. [UNICODE_30BF]
    print("3. [UNICODE_30BF]")
    response = client.post(f"/tasks/{test_uid}/{task_id}/start", json={})
    if response.status_code == 200:
        print("[UNICODE_2713] [UNICODE_30BF]")
    else:
        print(f"[UNICODE_2717] [UNICODE_30BF]: {response.status_code}")
    
    # 4. [UNICODE_30BF]
    print("4. [UNICODE_30BF]")
    complete_data = {
        "mood_score": 4,
        "actual_duration": 28,
        "notes": "[UNICODE_7D71]",
        "pomodoro_sessions_completed": 1
    }
    
    response = client.post(f"/tasks/{test_uid}/{task_id}/complete", json=complete_data)
    if response.status_code == 200:
        result = response.json()
        print(f"[UNICODE_2713] [UNICODE_30BF]: XP[UNICODE_7372] {result['xp_earned']}")
    else:
        print(f"[UNICODE_2717] [UNICODE_30BF]: {response.status_code}")
    
    # 5. [UNICODE_65E5]
    print("5. [UNICODE_65E5]")
    response = client.get(f"/tasks/{test_uid}/daily-summary")
    if response.status_code == 200:
        summary = response.json()
        print(f"[UNICODE_2713] [UNICODE_65E5]: {summary['total_tasks']}[UNICODE_30BF], [UNICODE_6B8B]{summary['remaining_slots']}[UNICODE_30B9]")
    else:
        print(f"[UNICODE_2717] [UNICODE_65E5]: {response.status_code}")
    
    # 6. [UNICODE_30D8]
    print("6. [UNICODE_30D8]")
    response = client.get("/health")
    if response.status_code == 200:
        print("[UNICODE_2713] [UNICODE_30D8]")
    else:
        print(f"[UNICODE_2717] [UNICODE_30D8]: {response.status_code}")
    
    print("\n[UNICODE_7D71]")