#!/usr/bin/env python3
"""
Simple Mood-XP Integration Test

[UNICODE_30BF]7.2[UNICODE_306E]:
- [UNICODE_6C17]XP[UNICODE_8A08]
- [UNICODE_6C17]
- [UNICODE_6C17]API[UNICODE_30A8]
- [UNICODE_6C17]

Requirements: 5.2, 5.4
"""

import sys
import os
from datetime import date, timedelta

# Add project root to path
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(__file__))))

def test_mood_xp_coefficient_calculation():
    """[UNICODE_6C17]-XP[UNICODE_4FC2]"""
    print("Testing mood-XP coefficient calculation...")
    
    try:
        from shared.interfaces.mood_system import mood_tracking_system
        
        test_uid = "xp_coeff_test"
        
        # [UNICODE_5404]
        mood_levels = [1, 2, 3, 4, 5]
        expected_basic_coeffs = [0.8, 0.9, 1.0, 1.1, 1.2]
        
        for mood_level, expected_coeff in zip(mood_levels, expected_basic_coeffs):
            mood_data = {
                'overall_mood': mood_level,
                'notes': f'Test mood level {mood_level}'
            }
            
            mood_entry = mood_tracking_system.log_mood(f"{test_uid}_{mood_level}", mood_data)
            
            # [UNICODE_57FA]
            basic_coeff = mood_entry.get_mood_coefficient()
            assert abs(basic_coeff - expected_coeff) < 0.01, f"Expected {expected_coeff}, got {basic_coeff}"
            
            # [UNICODE_91CD]
            weighted_coeff = mood_entry.get_weighted_mood_coefficient()
            assert 0.8 <= weighted_coeff <= 1.2, f"Weighted coefficient out of range: {weighted_coeff}"
            
            # XP[UNICODE_8A08]
            base_xp = 100
            adjusted_xp = int(base_xp * weighted_coeff)
            xp_bonus = adjusted_xp - base_xp
            
            print(f"  [UNICODE_2713] Mood {mood_level}: Basic={basic_coeff:.3f}, Weighted={weighted_coeff:.3f}, XP={base_xp}[UNICODE_2192]{adjusted_xp} (bonus: {xp_bonus:+d})")
        
        return True
    except Exception as e:
        print(f"  [UNICODE_2717] Mood-XP coefficient calculation failed: {e}")
        return False

def test_mood_history_analysis():
    """[UNICODE_6C17]"""
    print("Testing mood history analysis...")
    
    try:
        from shared.interfaces.mood_system import mood_tracking_system
        
        test_uid = "history_analysis_test"
        
        # 10[UNICODE_65E5]
        for i in range(10):
            test_date = date.today() - timedelta(days=9-i)
            mood_level = min(5, max(1, 2 + i // 2))  # 2[UNICODE_2192]3[UNICODE_2192]4[UNICODE_2192]5[UNICODE_306E]
            
            mood_data = {
                'date': test_date,
                'overall_mood': mood_level,
                'energy_level': mood_level,
                'motivation_level': mood_level,
                'notes': f'Day {i+1} mood'
            }
            
            mood_tracking_system.log_mood(test_uid, mood_data)
        
        # [UNICODE_5C65]
        recent_entries = mood_tracking_system.get_recent_mood_entries(test_uid, 10)
        assert len(recent_entries) == 10, f"Expected 10 entries, got {len(recent_entries)}"
        
        # [UNICODE_30C8]
        trend = mood_tracking_system.analyze_mood_trend(test_uid, 10)
        assert trend.period_days == 10
        assert trend.avg_overall_mood > 2.5  # [UNICODE_5E73]
        
        # [UNICODE_30A4]
        insights = mood_tracking_system.get_mood_insights(test_uid)
        assert 'latest_mood' in insights
        assert 'trend_direction' in insights
        assert insights['data_points'] == 10
        
        print(f"  [UNICODE_2713] History analysis completed: {len(recent_entries)} entries")
        print(f"  [UNICODE_2713] Average mood: {trend.avg_overall_mood:.2f}")
        print(f"  [UNICODE_2713] Trend direction: {insights['trend_direction']}")
        print(f"  [UNICODE_2713] Latest mood: {insights['latest_mood']}")
        
        return True
    except Exception as e:
        print(f"  [UNICODE_2717] Mood history analysis failed: {e}")
        return False

def test_therapeutic_feedback_generation():
    """[UNICODE_6CBB]"""
    print("Testing therapeutic feedback generation...")
    
    try:
        from shared.interfaces.mood_system import mood_tracking_system
        
        # [UNICODE_6CBB]
        def generate_therapeutic_feedback_local(mood_entry, mood_trend, adjusted_xp, base_xp):
            feedback = {
                "message": "",
                "encouragement": "",
                "insights": [],
                "mood_impact": ""
            }
            
            if not mood_entry:
                feedback["message"] = "[UNICODE_4ECA]XP[UNICODE_8ABF]"
                feedback["encouragement"] = "[UNICODE_6C17]"
                return feedback
            
            mood_level = mood_entry.overall_mood.value
            xp_bonus = adjusted_xp - base_xp
            
            if mood_level >= 4:
                feedback["message"] = f"[UNICODE_7D20]XP +{xp_bonus} [UNICODE_3092]"
                feedback["encouragement"] = "[UNICODE_3053]"
                feedback["mood_impact"] = "positive"
            elif mood_level == 3:
                feedback["message"] = "[UNICODE_666E]"
                feedback["encouragement"] = "[UNICODE_5B89]"
                feedback["mood_impact"] = "neutral"
            else:
                feedback["message"] = f"[UNICODE_8ABF]"
                feedback["encouragement"] = "[UNICODE_5C0F]"
                feedback["mood_impact"] = "challenging"
            
            if mood_entry.energy_level.value <= 2:
                feedback["insights"].append("[UNICODE_30A8]")
            if mood_entry.anxiety_level.value <= 2:
                feedback["insights"].append("[UNICODE_4E0D]")
            
            return feedback
        
        def generate_mood_based_recommendations_local(mood_entry, mood_coefficient):
            recommendations = []
            
            if not mood_entry:
                recommendations.append("[UNICODE_4ECA]")
                return recommendations
            
            mood_level = mood_entry.overall_mood.value
            
            if mood_level >= 4:
                recommendations.append("[UNICODE_826F]")
            elif mood_level == 3:
                recommendations.append("[UNICODE_5B89]")
            else:
                recommendations.append("[UNICODE_7121]")
            
            if mood_entry.energy_level.value <= 2:
                recommendations.append("[UNICODE_30A8]")
            
            return recommendations
        
        # [UNICODE_7570]
        test_cases = [
            {
                "mood_level": 5,
                "expected_impact": "positive",
                "description": "Very high mood"
            },
            {
                "mood_level": 3,
                "expected_impact": "neutral",
                "description": "Neutral mood"
            },
            {
                "mood_level": 1,
                "expected_impact": "challenging",
                "description": "Very low mood"
            }
        ]
        
        for i, test_case in enumerate(test_cases):
            test_uid = f"feedback_test_{i}"
            
            mood_data = {
                'overall_mood': test_case["mood_level"],
                'energy_level': test_case["mood_level"],
                'anxiety_level': 6 - test_case["mood_level"],  # [UNICODE_9006]
                'notes': f'Test case for {test_case["description"]}'
            }
            
            mood_entry = mood_tracking_system.log_mood(test_uid, mood_data)
            
            # [UNICODE_30D5]
            base_xp = 50
            adjusted_xp = int(base_xp * mood_entry.get_weighted_mood_coefficient())
            
            feedback = generate_therapeutic_feedback_local(mood_entry, None, adjusted_xp, base_xp)
            recommendations = generate_mood_based_recommendations_local(mood_entry, mood_entry.get_weighted_mood_coefficient())
            
            # [UNICODE_30D5]
            assert feedback["mood_impact"] == test_case["expected_impact"]
            assert len(feedback["message"]) > 0
            assert len(feedback["encouragement"]) > 0
            assert isinstance(feedback["insights"], list)
            
            # [UNICODE_63A8]
            assert isinstance(recommendations, list)
            assert len(recommendations) > 0
            
            print(f"  [UNICODE_2713] {test_case['description']}: Impact={feedback['mood_impact']}, Recommendations={len(recommendations)}")
            print(f"    Message: {feedback['message'][:50]}...")
        
        return True
    except Exception as e:
        print(f"  [UNICODE_2717] Therapeutic feedback generation failed: {e}")
        return False

def test_xp_integration_scenarios():
    """XP[UNICODE_7D71]"""
    print("Testing XP integration scenarios...")
    
    try:
        from shared.interfaces.mood_system import mood_tracking_system
        
        # [UNICODE_30B7]1: [UNICODE_9AD8]
        high_mood_uid = "high_mood_scenario"
        high_mood_data = {
            'overall_mood': 5,
            'energy_level': 5,
            'motivation_level': 5,
            'notes': '[UNICODE_4ECA]'
        }
        
        high_mood_entry = mood_tracking_system.log_mood(high_mood_uid, high_mood_data)
        high_coeff = high_mood_entry.get_weighted_mood_coefficient()
        
        base_xp = 100
        high_adjusted_xp = int(base_xp * high_coeff)
        high_bonus = high_adjusted_xp - base_xp
        
        assert high_coeff > 1.0, "High mood should have coefficient > 1.0"
        assert high_bonus > 0, "High mood should provide XP bonus"
        
        print(f"  [UNICODE_2713] High mood scenario: {base_xp} XP [UNICODE_2192] {high_adjusted_xp} XP (bonus: +{high_bonus})")
        
        # [UNICODE_30B7]2: [UNICODE_4F4E]
        low_mood_uid = "low_mood_scenario"
        low_mood_data = {
            'overall_mood': 1,
            'energy_level': 1,
            'motivation_level': 1,
            'anxiety_level': 1,  # [UNICODE_9AD8]
            'stress_level': 1,   # [UNICODE_9AD8]
            'notes': '[UNICODE_4ECA]...'
        }
        
        low_mood_entry = mood_tracking_system.log_mood(low_mood_uid, low_mood_data)
        low_coeff = low_mood_entry.get_weighted_mood_coefficient()
        
        low_adjusted_xp = int(base_xp * low_coeff)
        low_penalty = base_xp - low_adjusted_xp
        
        assert low_coeff < 1.0, "Low mood should have coefficient < 1.0"
        assert low_penalty > 0, "Low mood should reduce XP"
        
        print(f"  [UNICODE_2713] Low mood scenario: {base_xp} XP [UNICODE_2192] {low_adjusted_xp} XP (penalty: -{low_penalty})")
        
        # [UNICODE_30B7]3: [UNICODE_666E]
        neutral_mood_uid = "neutral_mood_scenario"
        neutral_mood_data = {
            'overall_mood': 3,
            'notes': '[UNICODE_666E]'
        }
        
        neutral_mood_entry = mood_tracking_system.log_mood(neutral_mood_uid, neutral_mood_data)
        neutral_coeff = neutral_mood_entry.get_weighted_mood_coefficient()
        
        neutral_adjusted_xp = int(base_xp * neutral_coeff)
        
        assert abs(neutral_coeff - 1.0) < 0.1, "Neutral mood should have coefficient [UNICODE_2248] 1.0"
        
        print(f"  [UNICODE_2713] Neutral mood scenario: {base_xp} XP [UNICODE_2192] {neutral_adjusted_xp} XP (coefficient: {neutral_coeff:.3f})")
        
        return True
    except Exception as e:
        print(f"  [UNICODE_2717] XP integration scenarios failed: {e}")
        return False

def test_api_endpoint_functions():
    """API[UNICODE_30A8]"""
    print("Testing API endpoint functions...")
    
    try:
        from shared.interfaces.mood_system import mood_tracking_system
        
        # [UNICODE_30ED]
        def generate_therapeutic_feedback_local(mood_entry, mood_trend, adjusted_xp, base_xp):
            feedback = {
                "message": "",
                "encouragement": "",
                "insights": [],
                "mood_impact": ""
            }
            
            if not mood_entry:
                return feedback
            
            mood_level = mood_entry.overall_mood.value
            xp_bonus = adjusted_xp - base_xp
            
            if mood_level >= 4:
                feedback["message"] = f"[UNICODE_7D20]XP +{xp_bonus} [UNICODE_3092]"
                feedback["mood_impact"] = "positive"
            elif mood_level == 3:
                feedback["message"] = "[UNICODE_666E]"
                feedback["mood_impact"] = "neutral"
            else:
                feedback["message"] = f"[UNICODE_8ABF]"
                feedback["mood_impact"] = "challenging"
            
            return feedback
        
        def generate_mood_based_recommendations_local(mood_entry, mood_coefficient):
            recommendations = []
            
            if not mood_entry:
                return recommendations
            
            mood_level = mood_entry.overall_mood.value
            
            if mood_level >= 4:
                recommendations.append("[UNICODE_826F]")
            elif mood_level == 3:
                recommendations.append("[UNICODE_5B89]")
            else:
                recommendations.append("[UNICODE_7121]")
            
            return recommendations
        
        test_uid = "api_function_test"
        
        # [UNICODE_6C17]
        mood_data = {
            'overall_mood': 4,
            'energy_level': 3,
            'motivation_level': 5,
            'focus_level': 2,
            'anxiety_level': 3,
            'stress_level': 2,
            'notes': 'API function test'
        }
        
        mood_entry = mood_tracking_system.log_mood(test_uid, mood_data)
        
        # [UNICODE_73FE]
        current_coeff = mood_tracking_system.get_current_mood_coefficient(test_uid)
        assert 0.8 <= current_coeff <= 1.2
        
        # XP[UNICODE_8A08]
        base_xp = 75
        adjusted_xp = int(base_xp * current_coeff)
        xp_bonus = adjusted_xp - base_xp
        
        # [UNICODE_6CBB]
        feedback = generate_therapeutic_feedback_local(mood_entry, None, adjusted_xp, base_xp)
        recommendations = generate_mood_based_recommendations_local(mood_entry, current_coeff)
        
        # [UNICODE_7D50]
        assert isinstance(feedback, dict)
        assert "message" in feedback
        assert "mood_impact" in feedback
        assert isinstance(recommendations, list)
        assert len(recommendations) > 0
        
        print(f"  [UNICODE_2713] Current coefficient: {current_coeff:.3f}")
        print(f"  [UNICODE_2713] XP calculation: {base_xp} [UNICODE_2192] {adjusted_xp} (bonus: {xp_bonus:+d})")
        print(f"  [UNICODE_2713] Feedback generated: {feedback['mood_impact']} impact")
        print(f"  [UNICODE_2713] Recommendations: {len(recommendations)} items")
        
        return True
    except Exception as e:
        print(f"  [UNICODE_2717] API endpoint functions test failed: {e}")
        return False

def run_all_integration_tests():
    """[UNICODE_3059]"""
    print("Running Mood-XP Integration Tests")
    print("=" * 60)
    
    tests = [
        ("Mood-XP Coefficient Calculation", test_mood_xp_coefficient_calculation),
        ("Mood History Analysis", test_mood_history_analysis),
        ("Therapeutic Feedback Generation", test_therapeutic_feedback_generation),
        ("XP Integration Scenarios", test_xp_integration_scenarios),
        ("API Endpoint Functions", test_api_endpoint_functions)
    ]
    
    passed = 0
    total = len(tests)
    
    for test_name, test_func in tests:
        print(f"\n{test_name}:")
        print("-" * 40)
        if test_func():
            passed += 1
            print(f"[UNICODE_2713] {test_name} PASSED")
        else:
            print(f"[UNICODE_2717] {test_name} FAILED")
    
    print("\n" + "=" * 60)
    print(f"Integration Test Results: {passed}/{total} tests passed")
    
    if passed == total:
        print("[UNICODE_2713] Task 7.2 Implementation VALIDATED")
        print("  - [UNICODE_6C17]XP[UNICODE_8A08] [UNICODE_2713]")
        print("  - [UNICODE_6C17] [UNICODE_2713]")
        print("  - [UNICODE_6C17]API[UNICODE_30A8] [UNICODE_2713]")
        print("  - [UNICODE_6C17] [UNICODE_2713]")
        return True
    else:
        print("[UNICODE_2717] Task 7.2 Implementation INCOMPLETE")
        return False

if __name__ == "__main__":
    success = run_all_integration_tests()
    exit(0 if success else 1)