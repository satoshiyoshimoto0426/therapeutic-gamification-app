"""
[UNICODE_30B3]

[UNICODE_5B63]
"""

import pytest
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', '..'))

from datetime import datetime, timedelta
from services.seasonal_events.main import EngagementSystem
import json

class TestCommunityIntegration:
    """[UNICODE_30B3]"""
    
    def setup_method(self):
        self.engagement = EngagementSystem()
        
        # [UNICODE_30C6]
        self.test_users = ["user_001", "user_002", "user_003", "user_004", "user_005"]
        
        # [UNICODE_30C6]
        self.test_guild = self.engagement.guild_system.create_guild(
            leader_uid="user_001",
            name="[UNICODE_7D71]",
            description="[UNICODE_7D71]",
            therapeutic_focus="adhd_peer"
        )
        
        # [UNICODE_4ED6]
        for user_uid in self.test_users[1:4]:  # user_002, user_003, user_004
            self.engagement.guild_system.join_guild(self.test_guild.guild_id, user_uid)
    
    def test_seasonal_event_guild_interaction(self):
        """[UNICODE_5B63]"""
        # [UNICODE_6625]
        spring_event = self.engagement.seasonal_events.create_seasonal_event("spring_renewal")
        
        # [UNICODE_30AE]
        for user_uid in self.test_users[:3]:
            # [UNICODE_65B0]
            self.engagement.process_user_action(user_uid, "new_habit_started", 1)
            # [UNICODE_9023]
            self.engagement.process_user_action(user_uid, "consecutive_day", 1)
        
        # [UNICODE_30AE]XP[UNICODE_304C]
        assert self.test_guild.total_xp > 0
        
        # [UNICODE_30A4]
        user_progress = {
            "new_habits_started": 3,
            "consecutive_days": 7
        }
        
        # [UNICODE_30A4]
        is_completed = self.engagement.seasonal_events.check_event_completion(
            spring_event.event_id, user_progress
        )
        assert is_completed is True
    
    def test_community_goal_guild_collaboration(self):
        """[UNICODE_30B3]"""
        # [UNICODE_5927]
        community_goal = self.engagement.community_goals.create_community_goal(
            title="[UNICODE_30AE]",
            description="[UNICODE_8907]",
            target_value=50,
            duration_days=14,
            reward_per_participant={"xp": 100, "coins": 75, "items": ["collaboration_badge"]}
        )
        
        # [UNICODE_5225]
        second_guild = self.engagement.guild_system.create_guild(
            leader_uid="user_005",
            name="[UNICODE_7B2C]",
            description="[UNICODE_5354]",
            therapeutic_focus="anxiety_support"
        )
        
        # [UNICODE_4E21]
        guild1_contribution = 0
        guild2_contribution = 0
        
        # [UNICODE_7B2C]
        for user_uid in self.test_users[:4]:
            contribution = 8
            self.engagement.community_goals.contribute_to_goal(
                community_goal.goal_id, user_uid, contribution
            )
            guild1_contribution += contribution
        
        # [UNICODE_7B2C]
        contribution = 18  # [UNICODE_76EE]
        self.engagement.community_goals.contribute_to_goal(
            community_goal.goal_id, "user_005", contribution
        )
        guild2_contribution += contribution
        
        # [UNICODE_76EE]
        assert community_goal.current_value >= community_goal.target_value
        assert community_goal.is_completed is True
        
        # [UNICODE_4E21]
        assert len(community_goal.participating_users) == 5
        assert all(user in community_goal.participating_users for user in self.test_users)
    
    def test_multi_event_participation(self):
        """[UNICODE_8907]"""
        # [UNICODE_8907]
        spring_event = self.engagement.seasonal_events.create_seasonal_event("spring_renewal")
        summer_event = self.engagement.seasonal_events.create_seasonal_event("summer_energy")
        
        # [UNICODE_8907]
        task_goal = self.engagement.community_goals.create_community_goal(
            title="[UNICODE_30BF]",
            description="[UNICODE_307F]",
            target_value=100,
            duration_days=21,
            reward_per_participant={"xp": 150}
        )
        
        social_goal = self.engagement.community_goals.create_community_goal(
            title="[UNICODE_793E]",
            description="[UNICODE_793E]",
            target_value=50,
            duration_days=14,
            reward_per_participant={"xp": 120}
        )
        
        # [UNICODE_30E6]
        test_user = "user_001"
        
        # [UNICODE_69D8]
        actions = [
            ("task_completed", 15),
            ("social_interaction", 8),
            ("new_habit_started", 2),
            ("physical_task", 5),
            ("reflection_entry", 3)
        ]
        
        for action_type, count in actions:
            self.engagement.process_user_action(test_user, action_type, count)
        
        # [UNICODE_30A8]
        engagement_data = self.engagement.get_user_engagement_data(test_user)
        
        # [UNICODE_8907]
        assert len(engagement_data["active_events"]) == 2
        
        # [UNICODE_8907]
        assert len(engagement_data["community_goals"]) == 2
        
        # [UNICODE_30AE]XP[UNICODE_304C]
        assert engagement_data["user_guild"]["total_xp"] > 0
    
    def test_guild_leaderboard_dynamics(self):
        """[UNICODE_30AE]"""
        # [UNICODE_8907]
        guilds = []
        for i in range(3):
            guild = self.engagement.guild_system.create_guild(
                leader_uid=f"leader_{i+1}",
                name=f"[UNICODE_7AF6]{i+1}",
                description=f"[UNICODE_30E9]{i+1}",
                therapeutic_focus="social_reintegration"
            )
            guilds.append(guild)
            
            # [UNICODE_5404]
            for j in range(3):
                member_uid = f"member_{i+1}_{j+1}"
                self.engagement.guild_system.join_guild(guild.guild_id, member_uid)
        
        # [UNICODE_5404]
        guild_activities = [
            (guilds[0], 20),  # [UNICODE_6700]
            (guilds[1], 15),  # [UNICODE_4E2D]
            (guilds[2], 10)   # [UNICODE_6700]
        ]
        
        for guild, activity_count in guild_activities:
            for member_uid in guild.members:
                self.engagement.process_user_action(member_uid, "task_completed", activity_count)
        
        # [UNICODE_30E9]
        leaderboard = self.engagement.guild_system.get_guild_leaderboard()
        
        # [UNICODE_30E9]
        assert len(leaderboard) >= 3
        assert leaderboard[0].total_xp > leaderboard[1].total_xp
        assert leaderboard[1].total_xp > leaderboard[2].total_xp
        
        # [UNICODE_6700]1[UNICODE_4F4D]
        assert leaderboard[0].guild_id == guilds[0].guild_id
    
    def test_therapeutic_focus_matching(self):
        """[UNICODE_6CBB]"""
        # [UNICODE_7570]
        therapeutic_focuses = ["adhd_peer", "anxiety_support", "social_reintegration"]
        focus_guilds = {}
        
        for focus in therapeutic_focuses:
            guild = self.engagement.guild_system.create_guild(
                leader_uid=f"leader_{focus}",
                name=f"{focus}[UNICODE_30AE]",
                description=f"{focus}[UNICODE_306B]",
                therapeutic_focus=focus
            )
            focus_guilds[focus] = guild
        
        # [UNICODE_5404]
        focus_events = {
            "adhd_peer": self.engagement.seasonal_events.create_seasonal_event("spring_renewal"),
            "anxiety_support": self.engagement.seasonal_events.create_seasonal_event("autumn_reflection"),
            "social_reintegration": self.engagement.seasonal_events.create_seasonal_event("winter_warmth")
        }
        
        # [UNICODE_5404]
        for focus, guild in focus_guilds.items():
            event = focus_events[focus]
            
            # [UNICODE_30AE]
            if focus == "adhd_peer":
                self.engagement.process_user_action(guild.leader_uid, "new_habit_started", 3)
            elif focus == "anxiety_support":
                self.engagement.process_user_action(guild.leader_uid, "reflection_entry", 5)
            elif focus == "social_reintegration":
                self.engagement.process_user_action(guild.leader_uid, "social_interaction", 8)
        
        # [UNICODE_5404]
        for focus, guild in focus_guilds.items():
            assert guild.total_xp > 0
            assert guild.therapeutic_focus == focus
    
    def test_long_term_engagement_simulation(self):
        """[UNICODE_9577]"""
        # 30[UNICODE_65E5]
        test_user = "user_001"
        
        # [UNICODE_9031]
        weekly_patterns = [
            # [UNICODE_7B2C]1[UNICODE_9031]: [UNICODE_7A4D]
            {"task_completed": 20, "social_interaction": 10, "reflection_entry": 7},
            # [UNICODE_7B2C]2[UNICODE_9031]: [UNICODE_4E2D]
            {"task_completed": 15, "social_interaction": 6, "reflection_entry": 5},
            # [UNICODE_7B2C]3[UNICODE_9031]: [UNICODE_4F4E]
            {"task_completed": 8, "social_interaction": 3, "reflection_entry": 2},
            # [UNICODE_7B2C]4[UNICODE_9031]: [UNICODE_56DE]
            {"task_completed": 18, "social_interaction": 9, "reflection_entry": 6}
        ]
        
        # [UNICODE_5404]
        for week, pattern in enumerate(weekly_patterns):
            for action_type, count in pattern.items():
                self.engagement.process_user_action(test_user, action_type, count)
        
        # [UNICODE_6700]
        final_engagement = self.engagement.get_user_engagement_data(test_user)
        
        # [UNICODE_30AE]
        assert final_engagement["user_guild"]["total_xp"] > 0
        assert final_engagement["user_guild"]["guild_level"] >= 1
        
        # [UNICODE_30A2]
        # [UNICODE_3053]0[UNICODE_3067]
        assert len(final_engagement["active_events"]) >= 0
        assert len(final_engagement["community_goals"]) >= 0
        
        # [UNICODE_30E9]
        assert len(final_engagement["guild_leaderboard"]) > 0

def test_full_community_workflow():
    """[UNICODE_5B8C]"""
    engagement = EngagementSystem()
    
    # 1. [UNICODE_5B63]
    spring_event = engagement.seasonal_events.create_seasonal_event("spring_renewal")
    print(f"[UNICODE_2705] [UNICODE_5B63]: {spring_event.name}")
    
    # 2. [UNICODE_30AE]
    guild = engagement.guild_system.create_guild(
        leader_uid="user_001",
        name="[UNICODE_6625]",
        description="[UNICODE_6625]",
        therapeutic_focus="adhd_peer"
    )
    
    # [UNICODE_30E1]
    members = ["user_002", "user_003", "user_004"]
    for member in members:
        engagement.guild_system.join_guild(guild.guild_id, member)
    
    print(f"[UNICODE_2705] [UNICODE_30AE]: {guild.name} ([UNICODE_30E1]: {len(guild.members)})")
    
    # 3. [UNICODE_30B3]
    community_goal = engagement.community_goals.create_community_goal(
        title="[UNICODE_6625]",
        description="[UNICODE_30B3]100[UNICODE_500B]",
        target_value=100,
        duration_days=30,
        reward_per_participant={"xp": 200, "coins": 100, "items": ["spring_badge"]}
    )
    print(f"[UNICODE_2705] [UNICODE_30B3]: {community_goal.title}")
    
    # 4. [UNICODE_30E6]
    all_users = ["user_001", "user_002", "user_003", "user_004"]
    
    for user_uid in all_users:
        # [UNICODE_65B0]
        engagement.process_user_action(user_uid, "new_habit_started", 3)
        # [UNICODE_30BF]
        engagement.process_user_action(user_uid, "task_completed", 10)
        # [UNICODE_793E]
        engagement.process_user_action(user_uid, "social_interaction", 5)
        # [UNICODE_632F]
        engagement.process_user_action(user_uid, "reflection_entry", 2)
    
    print("[UNICODE_2705] [UNICODE_30E6]")
    
    # 5. [UNICODE_7D50]
    final_data = engagement.get_user_engagement_data("user_001")
    
    print(f"[UNICODE_2705] [UNICODE_6700]:")
    print(f"   - [UNICODE_30AE]: {final_data['user_guild']['guild_level']}")
    print(f"   - [UNICODE_30AE]XP: {final_data['user_guild']['total_xp']}")
    print(f"   - [UNICODE_30A2]: {len(final_data['active_events'])}")
    print(f"   - [UNICODE_30B3]: {len(final_data['community_goals'])}")
    print(f"   - [UNICODE_30B3]: {final_data['community_goals'][0]['current_value']}/{final_data['community_goals'][0]['target_value']}")
    
    # 6. [UNICODE_30A4]
    user_progress = {
        "new_habits_started": 3,
        "consecutive_days": 7
    }
    
    event_completed = engagement.seasonal_events.check_event_completion(
        spring_event.event_id, user_progress
    )
    
    print(f"[UNICODE_2705] [UNICODE_5B63]: {'[UNICODE_5B8C]' if event_completed else '[UNICODE_9032]'}")
    
    return {
        "success": True,
        "guild_level": final_data['user_guild']['guild_level'],
        "community_goal_progress": final_data['community_goals'][0]['current_value'],
        "event_completed": event_completed
    }

if __name__ == "__main__":
    # [UNICODE_7D71]
    result = test_full_community_workflow()
    print(f"\n[UNICODE_1F389] [UNICODE_7D71]: {json.dumps(result, indent=2, ensure_ascii=False)}")
    
    # [UNICODE_5358]
    pytest.main([__file__, "-v"])