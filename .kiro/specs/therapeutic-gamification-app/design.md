# æ²»ç™‚çš„ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ—ãƒªè¨­è¨ˆæ–‡æ›¸

## æ¦‚è¦

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ã€ADHDã€ä¸ç™»æ ¡ã€è‹¥å¹´NEETå±¤ã‚’å¯¾è±¡ã¨ã—ãŸæ²»ç™‚ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¹ã‚¯å®Œäº†ã¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œã‚’å®Œå…¨åŒæœŸã•ã›ã‚‹ã€Œãƒ‘ãƒ©ãƒ¬ãƒ«ãƒ—ãƒ­ãƒƒãƒˆæ§‹é€ ã€ã«ã‚ˆã‚Šã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€Œãƒ¦ã‚¦ã€ã¨åˆ©ç”¨è€…è‡ªèº«ã®ä¸¡æ–¹ã‚’åŒæ™‚ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã•ã›ã‚‹é©æ–°çš„ãªã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

ã‚·ã‚¹ãƒ†ãƒ ã¯5æ®µéšã®çŠ¶æ…‹æ©Ÿæ¢°ï¼ˆç„¡é–¢å¿ƒâ†’èˆˆå‘³â†’è¡Œå‹•â†’ç¶™ç¶šâ†’ç¿’æ…£åŒ–ï¼‰ã«åŸºã¥ã„ã¦è¨­è¨ˆã•ã‚Œã€JIS X 8341-3 AAAåŠã³WCAG 2.2 AAæº–æ‹ ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’æä¾›ã—ã¾ã™ã€‚æ²»ç™‚å®‰å…¨æ€§ã‚’æœ€å„ªå…ˆã¨ã—ã€CBTãƒ™ãƒ¼ã‚¹ã®èªçŸ¥å†æ§‹æˆã¨ACTç™‚æ³•çµ±åˆã«ã‚ˆã‚Šã€å¿ƒç†çš„ã«å®‰å…¨ãªç’°å¢ƒã§ã®è‡ªå·±åŠ¹åŠ›æ„Ÿå†æ§‹ç¯‰ã‚’æ”¯æ´ã—ã¾ã™ã€‚

**è¨­è¨ˆåŸå‰‡:**
- **æ²»ç™‚ã‚°ãƒ¬ãƒ¼ãƒ‰å“è³ª**: 98% F1ã‚¹ã‚³ã‚¢ã®å®‰å…¨æ€§æ¤œå‡ºã¨å¿ƒç†çš„é…æ…®
- **ADHDæœ€é©åŒ–**: èªçŸ¥è² è·è»½æ¸›ã¨ãƒ¯ãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ»ãƒ¯ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ
- **ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæœ€é©åŒ–UI/UX
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: JIS X 8341-3 AAAæº–æ‹ ã®åŒ…æ‹¬çš„è¨­è¨ˆ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–**: 1.2ç§’P95ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨20,000åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

ã‚·ã‚¹ãƒ†ãƒ ã¯5æ®µéšã®çŠ¶æ…‹æ©Ÿæ¢°ï¼ˆç„¡é–¢å¿ƒâ†’èˆˆå‘³â†’è¡Œå‹•â†’ç¶™ç¶šâ†’ç¿’æ…£åŒ–ï¼‰ã«åŸºã¥ã„ã¦è¨­è¨ˆã•ã‚Œã€JIS X 8341-3 AAAåŠã³WCAG 2.2 AAæº–æ‹ ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã‚’æä¾›ã—ã¾ã™ã€‚æ²»ç™‚å®‰å…¨æ€§ã‚’æœ€å„ªå…ˆã¨ã—ã€CBTãƒ™ãƒ¼ã‚¹ã®èªçŸ¥å†æ§‹æˆã¨ACTç™‚æ³•çµ±åˆã«ã‚ˆã‚Šã€å¿ƒç†çš„ã«å®‰å…¨ãªç’°å¢ƒã§ã®è‡ªå·±åŠ¹åŠ›æ„Ÿå†æ§‹ç¯‰ã‚’æ”¯æ´ã—ã¾ã™ã€‚

**è¨­è¨ˆåŸå‰‡:**
- **æ²»ç™‚ã‚°ãƒ¬ãƒ¼ãƒ‰å“è³ª**: 98% F1ã‚¹ã‚³ã‚¢ã®å®‰å…¨æ€§æ¤œå‡ºã¨å¿ƒç†çš„é…æ…®
- **ADHDæœ€é©åŒ–**: èªçŸ¥è² è·è»½æ¸›ã¨ãƒ¯ãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ»ãƒ¯ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ
- **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: JIS X 8341-3 AAAæº–æ‹ ã®åŒ…æ‹¬çš„è¨­è¨ˆ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦–**: 1.2ç§’P95ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã¨20,000åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆ

```mermaid
graph TB
    subgraph "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰"
        LINE[LINE Bot Interface]
        WEB[Web Portal]
        GUARD[Guardian Portal]
    end
    
    subgraph "ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹"
        AUTH[èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹]
        GAME[ã‚³ã‚¢ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³]
        STORY[AIã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³]
        TASK[ã‚¿ã‚¹ã‚¯ç®¡ç†]
        MOOD[æ°—åˆ†è¿½è·¡]
    end
    
    subgraph "å°‚é–€ã‚µãƒ¼ãƒ“ã‚¹"
        ADHD[ADHDæ”¯æ´]
        SAFETY[æ²»ç™‚å®‰å…¨æ€§]
        MANDALA[Mandalaã‚·ã‚¹ãƒ†ãƒ ]
    end
    
    subgraph "ãƒ‡ãƒ¼ã‚¿å±¤"
        FIRESTORE[(Firestore)]
        STORAGE[(Cloud Storage)]
    end
    
    LINE --> AUTH
    WEB --> AUTH
    GUARD --> AUTH
    
    AUTH --> GAME
    GAME --> STORY
    GAME --> TASK
    GAME --> MOOD
    GAME --> ADHD
    GAME --> SAFETY
    GAME --> MANDALA
    
    GAME --> FIRESTORE
    STORY --> FIRESTORE
    TASK --> FIRESTORE
</mermaid>

### ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

- **èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹** (`services/auth/`): RBACã€SAMLã€Magic Linkèªè¨¼
- **ã‚³ã‚¢ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³** (`services/core-game/`): XPã€ãƒ¬ãƒ™ãƒ«ã€å…±é³´ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
- **AIã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³** (`services/ai-story/`): GPT-4oé§†å‹•ã®å‹•çš„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ
- **ã‚¿ã‚¹ã‚¯ç®¡ç†** (`services/task-mgmt/`): 4ç¨®é¡ã®ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—ã¨Pomodoroçµ±åˆ
- **æ°—åˆ†è¿½è·¡** (`services/mood-tracking/`): æ—¥æ¬¡æ°—åˆ†ãƒ­ã‚°ã¨XPä¿‚æ•°èª¿æ•´
- **ADHDæ”¯æ´** (`services/adhd-support/`): èªçŸ¥è² è·è»½æ¸›ã¨ã‚¢ã‚·ã‚¹ãƒˆæ©Ÿèƒ½
- **æ²»ç™‚å®‰å…¨æ€§** (`services/therapeutic-safety/`): ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨CBTä»‹å…¥
- **LINE Bot** (`services/line-bot/`): ä¸»è¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- **ã‚¹ãƒˆãƒ¼ãƒªãƒ¼DAG** (`services/story-dag/`): ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ§‹é€ ç®¡ç†

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### ã‚³ã‚¢ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³

#### XPã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

```python
# XPè¨ˆç®—å¼
XP = Î£(difficulty Ã— mood_coefficient Ã— adhd_assist)

# ä¿‚æ•°ç¯„å›²
mood_coefficient: 0.8-1.2  # æ°—åˆ†ãƒ­ã‚°(1-5)ã«åŸºã¥ã
adhd_assist: 1.0-1.3       # Pomodoro/ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ä½¿ç”¨é »åº¦
difficulty: 1-5            # ã‚¿ã‚¹ã‚¯é›£æ˜“åº¦
```

#### ãƒ¬ãƒ™ãƒ«é€²è¡Œã‚·ã‚¹ãƒ†ãƒ 

```python
class LevelSystem:
    def calculate_level(self, total_xp: int) -> int:
        # æŒ‡æ•°é–¢æ•°çš„ãƒ¬ãƒ™ãƒ«é€²è¡Œ
        return int(math.log2(total_xp / 100 + 1))
    
    def xp_for_next_level(self, current_level: int) -> int:
        return (2 ** (current_level + 1) - 1) * 100
    
    def check_resonance_event(self, yu_level: int, player_level: int) -> bool:
        # ãƒ¬ãƒ™ãƒ«å·®5ä»¥ä¸Šã§å…±é³´ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
        return abs(yu_level - player_level) >= 5
```

#### 8å±æ€§ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚·ã‚¹ãƒ†ãƒ 

```python
CRYSTAL_ATTRIBUTES = [
    "Self-Discipline",    # è‡ªå¾‹æ€§
    "Empathy",           # å…±æ„ŸåŠ›
    "Resilience",        # å›å¾©åŠ›
    "Curiosity",         # å¥½å¥‡å¿ƒ
    "Communication",     # ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    "Creativity",        # å‰µé€ æ€§
    "Courage",           # å‹‡æ°—
    "Wisdom"             # çŸ¥æµ
]

class CrystalGauge:
    def __init__(self):
        self.gauges = {attr: 0 for attr in CRYSTAL_ATTRIBUTES}
        self.max_value = 100
    
    def add_progress(self, attribute: str, points: int):
        self.gauges[attribute] = min(self.max_value, 
                                   self.gauges[attribute] + points)
    
    def is_chapter_unlocked(self, attribute: str) -> bool:
        return self.gauges[attribute] >= 100
```

### Mandalaã‚·ã‚¹ãƒ†ãƒ 

#### 9x9ã‚°ãƒªãƒƒãƒ‰æ§‹é€ 

```python
class MandalaGrid:
    def __init__(self):
        self.grid = [[None for _ in range(9)] for _ in range(9)]
        self.center_values = self._initialize_core_values()
        self.memory_cells = {}  # 81å€‹ã®ã‚¯ã‚¨ã‚¹ãƒˆ
    
    def _initialize_core_values(self):
        # ä¸­å¤®ã«å›ºå®šä¾¡å€¤è¦³ï¼ˆACTç™‚æ³•çµ±åˆï¼‰
        return {
            (4, 4): "Core Self",  # ä¸­å¿ƒ
            (3, 4): "Compassion",
            (5, 4): "Growth",
            (4, 3): "Authenticity",
            (4, 5): "Connection"
        }
    
    def unlock_cell(self, x: int, y: int, quest_data: dict):
        if self._can_unlock(x, y):
            self.grid[x][y] = quest_data
            return True
        return False
    
    def get_api_response(self, uid: str) -> dict:
        return {
            "uid": uid,
            "grid": self._serialize_grid(),
            "unlocked_count": self._count_unlocked(),
            "total_cells": 81
        }
```

### AIã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¨ãƒ³ã‚¸ãƒ³

#### ã‚¹ãƒˆãƒ¼ãƒªãƒ¼DAGæ§‹é€ 

```python
class StoryDAG:
    def __init__(self):
        self.chapters = {}  # CHAPTER -> NODE -> EDGE
        self.current_state = {}
    
    def generate_story_content(self, user_context: dict) -> dict:
        prompt = self._build_prompt(user_context)
        
        # GPT-4oå‘¼ã³å‡ºã—ï¼ˆ3.5ç§’ä»¥å†…ï¼‰
        response = self.openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "system", "content": prompt}],
            response_format={"type": "json_object"},
            timeout=3.5
        )
        
        return self._validate_story_schema(response.choices[0].message.content)
    
    def _build_prompt(self, context: dict) -> str:
        return f"""
        æ²»ç™‚çš„ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆ:
        - ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹: {context['mood']}/5
        - å®Œäº†ã‚¿ã‚¹ã‚¯: {context['completed_tasks']}
        - ç¾åœ¨ç« : {context['current_chapter']}
        
        ä»¥ä¸‹ã®JSONå½¢å¼ã§å¿œç­”:
        {{
            "story_text": "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹",
            "choices": [
                {{
                    "text": "é¸æŠè‚¢ãƒ†ã‚­ã‚¹ãƒˆ",
                    "real_task_id": "task_123",
                    "xp_reward": 50
                }}
            ],
            "therapeutic_elements": ["CBT", "ACT"]
        }}
        """
```

#### æ²»ç™‚å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯

```python
class TherapeuticSafety:
    def __init__(self):
        self.moderation_client = OpenAI()
        self.custom_filters = self._load_custom_filters()
    
    def validate_content(self, content: str) -> dict:
        # OpenAI Moderation
        moderation = self.moderation_client.moderations.create(input=content)
        
        # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆè‡ªå‚·ãƒªã‚¹ã‚¯æ¤œå‡ºï¼‰
        custom_score = self._check_self_harm_triggers(content)
        
        return {
            "safe": not moderation.results[0].flagged and custom_score < 0.02,
            "confidence": custom_score,
            "target_f1": 0.98  # 98% F1ã‚¹ã‚³ã‚¢ç›®æ¨™
        }
    
    def generate_cbt_intervention(self, negative_pattern: str) -> str:
        # CBTãƒ™ãƒ¼ã‚¹ã®èªçŸ¥å†æ§‹æˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        return self._create_story_break_dialog(negative_pattern)
```

### RPGçµŒæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã¨ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†

#### ã‚³ã‚¤ãƒ³çµŒæ¸ˆã‚·ã‚¹ãƒ†ãƒ 

```python
class CoinEconomy:
    def __init__(self):
        self.base_coin_rates = {
            "task_completion": {"routine": 10, "one_shot": 15, "skill_up": 20, "social": 25},
            "demon_defeat": {"common": 50, "rare": 100, "epic": 200, "legendary": 500},
            "daily_bonus": 30,
            "streak_bonus": {"7_days": 100, "30_days": 500, "100_days": 2000}
        }
    
    def calculate_coin_reward(self, action_type: str, difficulty: int, 
                            performance_multiplier: float = 1.0) -> int:
        base_coins = self.base_coin_rates.get(action_type, {}).get("routine", 10)
        return int(base_coins * difficulty * performance_multiplier)
    
    def apply_inflation_control(self, user_total_coins: int) -> float:
        # çµŒæ¸ˆãƒãƒ©ãƒ³ã‚¹ç¶­æŒã®ãŸã‚ã®ã‚¤ãƒ³ãƒ•ãƒ¬åˆ¶å¾¡
        if user_total_coins > 10000:
            return 0.8  # 20%æ¸›å°‘
        elif user_total_coins > 5000:
            return 0.9  # 10%æ¸›å°‘
        return 1.0
```

#### ã‚¬ãƒãƒ£ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

```python
class GachaSystem:
    def __init__(self):
        self.rarity_rates = {
            "common": 0.60,     # 60%
            "uncommon": 0.25,   # 25%
            "rare": 0.10,       # 10%
            "epic": 0.04,       # 4%
            "legendary": 0.01   # 1%
        }
        self.gacha_costs = {
            "single": 100,
            "ten_pull": 900,    # 10%å‰²å¼•
            "premium": 300      # ãƒ¬ã‚¢ç¢ºç‡2å€
        }
    
    def perform_gacha(self, gacha_type: str, user_coins: int) -> dict:
        cost = self.gacha_costs[gacha_type]
        if user_coins < cost:
            return {"success": False, "error": "insufficient_coins"}
        
        items = []
        pulls = 10 if gacha_type == "ten_pull" else 1
        
        for _ in range(pulls):
            rarity = self._determine_rarity(gacha_type == "premium")
            item = self._generate_item(rarity)
            items.append(item)
        
        return {
            "success": True,
            "items": items,
            "coins_spent": cost,
            "guaranteed_rare": gacha_type == "ten_pull" and not any(i["rarity"] in ["rare", "epic", "legendary"] for i in items)
        }
```

#### è£…å‚™ã‚·ã‚¹ãƒ†ãƒ 

```python
class EquipmentSystem:
    def __init__(self):
        self.equipment_slots = {
            "weapon": None,
            "armor": None,
            "accessory": None,
            "consumable_1": None,
            "consumable_2": None,
            "consumable_3": None
        }
        self.stat_bonuses = {
            "focus": 0,      # ã‚¿ã‚¹ã‚¯é›†ä¸­åŠ›å‘ä¸Š
            "resilience": 0, # ã‚¹ãƒˆãƒ¬ã‚¹è€æ€§
            "motivation": 0, # ã‚„ã‚‹æ°—æŒç¶š
            "social": 0,     # ç¤¾ä¼šæ€§å‘ä¸Š
            "creativity": 0, # å‰µé€ æ€§å‘ä¸Š
            "wisdom": 0      # å­¦ç¿’åŠ¹ç‡
        }
    
    def equip_item(self, item: dict, slot: str) -> bool:
        if slot not in self.equipment_slots:
            return False
        
        # æ—¢å­˜è£…å‚™ã®åŠ¹æœã‚’å‰Šé™¤
        if self.equipment_slots[slot]:
            self._remove_stat_bonuses(self.equipment_slots[slot])
        
        # æ–°è£…å‚™ã®åŠ¹æœã‚’é©ç”¨
        self.equipment_slots[slot] = item
        self._apply_stat_bonuses(item)
        return True
    
    def calculate_task_completion_bonus(self) -> float:
        # è£…å‚™ã«ã‚ˆã‚‹ä½œæ¥­åŠ¹ç‡ãƒœãƒ¼ãƒŠã‚¹
        focus_bonus = self.stat_bonuses["focus"] * 0.02  # 2%/point
        motivation_bonus = self.stat_bonuses["motivation"] * 0.015  # 1.5%/point
        return min(0.5, focus_bonus + motivation_bonus)  # æœ€å¤§50%ãƒœãƒ¼ãƒŠã‚¹
```

### è·æ¥­ã‚·ã‚¹ãƒ†ãƒ ã¨æˆé•·ãƒ‘ã‚¹

#### åŸºæœ¬è·æ¥­ã‚·ã‚¹ãƒ†ãƒ 

```python
class JobSystem:
    def __init__(self):
        self.base_jobs = {
            "warrior": {
                "name": "æˆ¦å£«",
                "focus": "Self-Discipline",
                "bonuses": {"resilience": 2, "focus": 1},
                "skills": ["iron_will", "task_crusher", "deadline_guardian"],
                "therapeutic_focus": "ç¿’æ…£å½¢æˆã¨è‡ªåˆ¶å¿ƒ"
            },
            "hero": {
                "name": "å‹‡è€…",
                "focus": "Courage",
                "bonuses": {"motivation": 2, "social": 1},
                "skills": ["fear_conqueror", "social_bridge", "hope_bringer"],
                "therapeutic_focus": "ç¤¾ä¼šå¾©å¸°ã¨å‹‡æ°—"
            },
            "mage": {
                "name": "é­”æ³•ä½¿ã„",
                "focus": "Creativity",
                "bonuses": {"creativity": 2, "wisdom": 1},
                "skills": ["idea_spark", "problem_solver", "innovation_master"],
                "therapeutic_focus": "å‰µé€ æ€§ã¨å•é¡Œè§£æ±º"
            },
            "priest": {
                "name": "åƒ§ä¾¶",
                "focus": "Empathy",
                "bonuses": {"social": 2, "resilience": 1},
                "skills": ["emotional_heal", "empathy_boost", "community_bond"],
                "therapeutic_focus": "å…±æ„ŸåŠ›ã¨ç™’ã—"
            },
            "sage": {
                "name": "è³¢è€…",
                "focus": "Wisdom",
                "bonuses": {"wisdom": 2, "focus": 1},
                "skills": ["deep_insight", "learning_accelerator", "mindful_awareness"],
                "therapeutic_focus": "å­¦ç¿’ã¨è‡ªå·±ç†è§£"
            },
            "ninja": {
                "name": "å¿è€…",
                "focus": "Resilience",
                "bonuses": {"resilience": 2, "motivation": 1},
                "skills": ["stress_shadow", "adaptation_master", "stealth_progress"],
                "therapeutic_focus": "ã‚¹ãƒˆãƒ¬ã‚¹ç®¡ç†ã¨é©å¿œåŠ›"
            }
        }
        
        self.advanced_jobs = {
            "paladin": {
                "requirements": {"warrior": 10, "priest": 5, "social_tasks": 50},
                "bonuses": {"resilience": 3, "social": 2, "motivation": 1}
            },
            "archmage": {
                "requirements": {"mage": 15, "wisdom": 20, "creative_tasks": 100},
                "bonuses": {"creativity": 4, "wisdom": 3}
            },
            "shadow_master": {
                "requirements": {"ninja": 12, "resilience": 25, "stress_overcome": 30},
                "bonuses": {"resilience": 4, "focus": 2}
            }
        }
    
    def check_job_unlock(self, user_stats: dict, target_job: str) -> bool:
        requirements = self.advanced_jobs.get(target_job, {}).get("requirements", {})
        for req_key, req_value in requirements.items():
            if user_stats.get(req_key, 0) < req_value:
                return False
        return True
```

### å†…ãªã‚‹é­”ç‰©ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ 

#### ãƒãƒˆãƒ«ã‚¨ãƒ³ã‚¸ãƒ³

```python
class InnerDemonBattle:
    def __init__(self):
        self.demon_types = {
            "procrastination_dragon": {
                "name": "å…ˆå»¶ã°ã—ãƒ‰ãƒ©ã‚´ãƒ³",
                "hp": 100,
                "weakness": ["routine_tasks", "pomodoro_usage"],
                "rewards": {"coins": 150, "items": ["focus_potion", "time_crystal"]},
                "therapeutic_message": "å°ã•ãªä¸€æ­©ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã®å¤§åˆ‡ã•"
            },
            "anxiety_shadow": {
                "name": "ä¸å®‰ã®å½±",
                "hp": 80,
                "weakness": ["breathing_exercise", "positive_affirmation"],
                "rewards": {"coins": 120, "items": ["calm_amulet", "courage_ring"]},
                "therapeutic_message": "ä¸å®‰ã¯æˆé•·ã®ã‚µã‚¤ãƒ³"
            },
            "depression_void": {
                "name": "æ†‚é¬±ã®è™šç„¡",
                "hp": 150,
                "weakness": ["social_connection", "creative_expression"],
                "rewards": {"coins": 200, "items": ["hope_crystal", "energy_elixir"]},
                "therapeutic_message": "ã¤ãªãŒã‚ŠãŒé—‡ã‚’ç…§ã‚‰ã™"
            },
            "social_fear_goblin": {
                "name": "ç¤¾ä¼šææ€–ã‚´ãƒ–ãƒªãƒ³",
                "hp": 60,
                "weakness": ["small_social_tasks", "communication_practice"],
                "rewards": {"coins": 100, "items": ["confidence_badge", "social_key"]},
                "therapeutic_message": "å°ã•ãªå‹‡æ°—ãŒå¤§ããªå¤‰åŒ–ã‚’ç”Ÿã‚€"
            }
        }
    
    def initiate_battle(self, demon_type: str, user_recent_actions: List[str]) -> dict:
        demon = self.demon_types[demon_type].copy()
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€è¿‘ã®è¡Œå‹•ã«åŸºã¥ããƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
        damage = 0
        for action in user_recent_actions:
            if action in demon["weakness"]:
                damage += 25
        
        demon["hp"] -= damage
        
        if demon["hp"] <= 0:
            return {
                "result": "victory",
                "rewards": demon["rewards"],
                "message": demon["therapeutic_message"],
                "reflection_prompt": self._generate_cbt_reflection(demon_type)
            }
        else:
            return {
                "result": "ongoing",
                "demon_hp": demon["hp"],
                "suggested_actions": demon["weakness"],
                "encouragement": "ã“ã®é­”ç‰©ã‚’å€’ã™ã«ã¯ã€æ—¥ã€…ã®å°ã•ãªè¡Œå‹•ãŒæ­¦å™¨ã«ãªã‚Šã¾ã™"
            }
```

### æ—¥æ¬¡æŒ¯ã‚Šè¿”ã‚Šã¨ã‚°ãƒ«ãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ 

#### ã‚°ãƒ«ãƒãƒ¼ãƒˆæ§‹é€ åŒ–æŒ¯ã‚Šè¿”ã‚Š

```python
class GrowthNoteSystem:
    def __init__(self):
        self.reflection_prompts = {
            "current_problems": [
                "ç¾å®Ÿä¸–ç•Œã§ä»Šå›°ã£ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
                "ä»Šæ—¥ç›´é¢ã—ãŸèª²é¡Œã‚„æ‚©ã¿ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                "è§£æ±ºã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹å•é¡Œã¯ä½•ã§ã™ã‹ï¼Ÿ"
            ],
            "ideal_world": [
                "ã‚ãªãŸã«ã¨ã£ã¦ç†æƒ³çš„ãªä¸–ç•Œã¨ã¯ã©ã®ã‚ˆã†ãªä¸–ç•Œã§ã™ã‹ï¼Ÿ",
                "ã‚‚ã—å…¨ã¦ãŒæ€ã„é€šã‚Šã«ãªã‚‹ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªçŠ¶æ³ã«ãªã£ã¦ã„ãŸã„ã§ã™ã‹ï¼Ÿ",
                "ç†æƒ³ã®è‡ªåˆ†ã‚„ç’°å¢ƒã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„"
            ],
            "ideal_emotions": [
                "ç†æƒ³çš„ãªä¸–ç•Œã«ä½ã‚€ã‚ãªãŸã¯ã©ã‚“ãªæ„Ÿæƒ…ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã‹ï¼Ÿ",
                "ãã®ç†æƒ³ã®çŠ¶æ³ã§ã€ã‚ãªãŸã¯ã©ã‚“ãªæ°—æŒã¡ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
                "ç†æƒ³ãŒå®Ÿç¾ã—ãŸæ™‚ã®æ„Ÿæƒ…ã‚’å…·ä½“çš„ã«æƒ³åƒã—ã¦ã¿ã¦ãã ã•ã„"
            ],
            "tomorrow_actions": [
                "æ˜æ—¥ã‹ã‚‰ä½•ãŒã§ãã¾ã™ã‹ï¼Ÿ",
                "ç†æƒ³ã«è¿‘ã¥ããŸã‚ã«æ˜æ—¥ã§ãã‚‹å°ã•ãªä¸€æ­©ã¯ä½•ã§ã™ã‹ï¼Ÿ",
                "ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚’è¸ã¾ãˆã¦ã€æ˜æ—¥å–ã‚Šçµ„ã¿ãŸã„ã“ã¨ã¯ï¼Ÿ"
            ]
        }
        self.reflection_xp_base = 25
    
    def generate_reflection_prompt(self, user_context: dict) -> dict:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
        mood = user_context.get("mood", 3)
        completed_tasks = user_context.get("completed_tasks", 0)
        
        return {
            "current_problems_prompt": self._select_contextual_prompt("current_problems", mood, completed_tasks),
            "ideal_world_prompt": self._select_contextual_prompt("ideal_world", mood, completed_tasks),
            "ideal_emotions_prompt": self._select_contextual_prompt("ideal_emotions", mood, completed_tasks),
            "tomorrow_actions_prompt": self._select_contextual_prompt("tomorrow_actions", mood, completed_tasks),
            "estimated_time": "10-15åˆ†",
            "xp_reward": self.reflection_xp_base
        }
    
    def process_reflection(self, reflection_data: dict) -> dict:
        # æŒ¯ã‚Šè¿”ã‚Šå†…å®¹ã®åˆ†æã¨æ¬¡å›ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã¸ã®æ´»ç”¨
        current_problems = reflection_data.get("current_problems", "")
        ideal_world = reflection_data.get("ideal_world", "")
        ideal_emotions = reflection_data.get("ideal_emotions", "")
        tomorrow_actions = reflection_data.get("tomorrow_actions", "")
        
        # æ„Ÿæƒ…åˆ†æã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
        emotional_tone = self._analyze_emotional_tone(ideal_emotions)
        problem_themes = self._extract_problem_themes(current_problems)
        action_orientation = self._analyze_action_orientation(tomorrow_actions)
        
        return {
            "reflection_completed": True,
            "emotional_tone": emotional_tone,
            "problem_themes": problem_themes,
            "action_orientation": action_orientation,
            "xp_earned": self.reflection_xp_base,
            "story_personalization_data": {
                "current_challenges": problem_themes,
                "ideal_vision": self._extract_key_themes(ideal_world),
                "emotional_state": emotional_tone,
                "action_readiness": action_orientation
            }
        }
    
    def check_reflection_streak(self, user_id: str) -> dict:
        # æŒ¯ã‚Šè¿”ã‚Šç¶™ç¶šçŠ¶æ³ã®ç¢ºèª
        streak_data = self._get_reflection_history(user_id)
        
        return {
            "current_streak": streak_data["consecutive_days"],
            "total_reflections": streak_data["total_count"],
            "missed_days": streak_data["missed_in_last_week"],
            "needs_reminder": streak_data["missed_in_last_week"] >= 2
        }
```

#### LINE BotæŒ¯ã‚Šè¿”ã‚ŠUI

```python
class ReflectionLINEInterface:
    def create_reflection_prompt_message(self, prompts: dict) -> dict:
        """22:00ã®æŒ¯ã‚Šè¿”ã‚Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"""
        return {
            "type": "flex",
            "altText": "ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚¿ã‚¤ãƒ ğŸŒ™",
            "contents": {
                "type": "bubble",
                "header": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "text",
                            "text": "ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šã‚¿ã‚¤ãƒ ",
                            "weight": "bold",
                            "size": "lg",
                            "color": "#2E3A59"
                        },
                        {
                            "type": "text",
                            "text": "ã‚°ãƒ«ãƒãƒ¼ãƒˆå½¢å¼ã§ä»Šæ—¥ã‚’æŒ¯ã‚Šè¿”ã‚Šã¾ã—ã‚‡ã†",
                            "size": "sm",
                            "color": "#666666",
                            "wrap": True
                        }
                    ]
                },
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        self._create_reflection_section("ğŸ˜Ÿ â‘ ç¾å®Ÿä¸–ç•Œã§å›°ã£ã¦ã„ã‚‹ã“ã¨", prompts["current_problems_prompt"]),
                        self._create_reflection_section("âœ¨ â‘¡ç†æƒ³çš„ãªä¸–ç•Œã¨ã¯", prompts["ideal_world_prompt"]),
                        self._create_reflection_section("ğŸ˜Š â‘¢ç†æƒ³çš„ãªä¸–ç•Œã«ä½ã‚€ã‚ãªãŸã®æ„Ÿæƒ…ã¯ï¼Ÿ", prompts["ideal_emotions_prompt"]),
                        self._create_reflection_section("ğŸš€ â‘£æ˜æ—¥ã‹ã‚‰ä½•ãŒå‡ºæ¥ã‚‹ï¼Ÿ", prompts["tomorrow_actions_prompt"])
                    ]
                },
                "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                        {
                            "type": "button",
                            "style": "primary",
                            "action": {
                                "type": "uri",
                                "label": "ã‚°ãƒ«ãƒãƒ¼ãƒˆã‚’å§‹ã‚ã‚‹ (+25 XP)",
                                "uri": "line://app/growth-note-form"
                            }
                        }
                    ]
                }
            }
        }
    
    def create_reflection_reminder(self, missed_days: int) -> dict:
        """2æ—¥é€£ç¶šã‚¹ã‚­ãƒƒãƒ—æ™‚ã®ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼"""
        encouragement_messages = [
            "ã‚°ãƒ«ãƒãƒ¼ãƒˆã¯è‡ªåˆ†ã®æˆé•·ã‚’è¦‹ã¤ã‚ã‚‹å¤§åˆ‡ãªæ™‚é–“ã§ã™",
            "ç¾å®Ÿã¨ç†æƒ³ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã‚‹ç¬¬ä¸€æ­©ã¯æŒ¯ã‚Šè¿”ã‚Šã‹ã‚‰å§‹ã¾ã‚Šã¾ã™",
            "ä»Šæ—¥ã®è‡ªåˆ†ã¨å‘ãåˆã£ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ"
        ]
        
        return {
            "type": "text",
            "text": f"ğŸŒŸ {random.choice(encouragement_messages)}\n\nã‚°ãƒ«ãƒãƒ¼ãƒˆã‚’{missed_days}æ—¥ãŠä¼‘ã¿ã—ã¦ã„ã¾ã™ã­ã€‚ç„¡ç†ã‚’ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€çŸ­æ™‚é–“ã§ã‚‚è‡ªåˆ†ã®ç¾å®Ÿã¨ç†æƒ³ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ",
            "quickReply": {
                "items": [
                    {
                        "type": "action",
                        "action": {
                            "type": "message",
                            "label": "ä»Šã‹ã‚‰ã‚°ãƒ«ãƒãƒ¼ãƒˆ",
                            "text": "ã‚°ãƒ«ãƒãƒ¼ãƒˆã‚’å§‹ã‚ã‚‹"
                        }
                    },
                    {
                        "type": "action",
                        "action": {
                            "type": "message",
                            "label": "æ˜æ—¥ã«ã™ã‚‹",
                            "text": "æ˜æ—¥ã‚°ãƒ«ãƒãƒ¼ãƒˆã™ã‚‹"
                        }
                    }
                ]
            }
        }
    
    def create_growth_note_form(self) -> dict:
        """ã‚°ãƒ«ãƒãƒ¼ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ """
        return {
            "type": "flex",
            "altText": "ã‚°ãƒ«ãƒãƒ¼ãƒˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ",
            "contents": {
                "type": "carousel",
                "contents": [
                    self._create_form_bubble("â‘ ç¾å®Ÿä¸–ç•Œã§å›°ã£ã¦ã„ã‚‹ã“ã¨", "current_problems", "ğŸ˜Ÿ"),
                    self._create_form_bubble("â‘¡ç†æƒ³çš„ãªä¸–ç•Œã¨ã¯", "ideal_world", "âœ¨"),
                    self._create_form_bubble("â‘¢ç†æƒ³çš„ãªä¸–ç•Œã«ä½ã‚€ã‚ãªãŸã®æ„Ÿæƒ…ã¯ï¼Ÿ", "ideal_emotions", "ğŸ˜Š"),
                    self._create_form_bubble("â‘£æ˜æ—¥ã‹ã‚‰ä½•ãŒå‡ºæ¥ã‚‹ï¼Ÿ", "tomorrow_actions", "ğŸš€")
                ]
            }
        }
    
    def _create_form_bubble(self, title: str, field_name: str, emoji: str) -> dict:
        """å„ã‚°ãƒ«ãƒãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªã®å…¥åŠ›ãƒãƒ–ãƒ«"""
        return {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": f"{emoji} {title}",
                        "weight": "bold",
                        "size": "sm",
                        "wrap": True
                    }
                ]
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "style": "primary",
                        "action": {
                            "type": "uri",
                            "label": "å…¥åŠ›ã™ã‚‹",
                            "uri": f"line://app/growth-note-input?field={field_name}"
                        }
                    }
                ]
            }
        }
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### 5æ®µéšçŠ¶æ…‹æ©Ÿæ¢°

```python
class UserStateEngine:
    def __init__(self):
        self.states = {
            "APATHY": 0,      # ç„¡é–¢å¿ƒ
            "INTEREST": 1,    # èˆˆå‘³
            "ACTION": 2,      # è¡Œå‹•
            "CONTINUATION": 3, # ç¶™ç¶š
            "HABITUATION": 4  # ç¿’æ…£åŒ–
        }
        self.transition_thresholds = {
            "APATHY_TO_INTEREST": {"login_days": 3, "story_engagement": 0.2},
            "INTEREST_TO_ACTION": {"tasks_completed": 5, "xp_earned": 100},
            "ACTION_TO_CONTINUATION": {"consecutive_days": 7, "task_variety": 3},
            "CONTINUATION_TO_HABITUATION": {"streak_days": 21, "self_efficacy": 0.8}
        }
    
    def evaluate_state_transition(self, user_metrics: dict) -> str:
        current_state = user_metrics.get("current_state", "APATHY")
        
        # çŠ¶æ…‹é·ç§»ãƒ­ã‚¸ãƒƒã‚¯
        if current_state == "APATHY" and self._check_interest_criteria(user_metrics):
            return "INTEREST"
        elif current_state == "INTEREST" and self._check_action_criteria(user_metrics):
            return "ACTION"
        # ... ä»–ã®é·ç§»æ¡ä»¶
        
        return current_state
    
    def get_therapeutic_interventions(self, state: str) -> List[str]:
        interventions = {
            "APATHY": ["curiosity_sparking", "low_commitment_tasks"],
            "INTEREST": ["goal_setting", "achievement_visualization"],
            "ACTION": ["habit_stacking", "progress_tracking"],
            "CONTINUATION": ["challenge_scaling", "social_connection"],
            "HABITUATION": ["mastery_focus", "mentoring_others"]
        }
        return interventions.get(state, [])
```

### ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

#### 4ç¨®é¡ã®ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—

```python
class TaskType(Enum):
    ROUTINE = "routine"      # æ—¥å¸¸ç¿’æ…£
    ONE_SHOT = "one_shot"    # å˜ç™ºã‚¿ã‚¹ã‚¯
    SKILL_UP = "skill_up"    # ã‚¹ã‚­ãƒ«å‘ä¸Š
    SOCIAL = "social"        # ç¤¾ä¼šçš„æ´»å‹•

class Task:
    def __init__(self, task_type: TaskType, difficulty: int, 
                 description: str, habit_tag: str = None):
        self.type = task_type
        self.difficulty = difficulty  # 1-5
        self.description = description
        self.habit_tag = habit_tag
        self.completed = False
        self.completion_time = None
    
    def calculate_xp(self, mood_coefficient: float, 
                    adhd_assist: float) -> int:
        base_xp = self.difficulty * 10
        return int(base_xp * mood_coefficient * adhd_assist)
```

#### Pomodoroçµ±åˆ

```python
class PomodoroIntegration:
    def __init__(self):
        self.session_count = 0
        self.break_suggestions = []
    
    def start_session(self, duration: int = 25):
        # 25åˆ†ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
        self.session_count += 1
        
    def suggest_break(self, continuous_minutes: int) -> dict:
        if continuous_minutes >= 60:
            return {
                "type": "mandatory",
                "message": "ã€Œæ¯ã®å¿ƒé…ã€ãƒŠãƒ©ãƒ†ã‚£ãƒ–",
                "refuse_count": self._get_refuse_count()
            }
        return None
    
    def get_adhd_assist_multiplier(self) -> float:
        # ä½¿ç”¨é »åº¦ã«åŸºã¥ãã‚¢ã‚·ã‚¹ãƒˆä¿‚æ•°
        usage_rate = self.session_count / 30  # æœˆé–“ä½¿ç”¨ç‡
        return min(1.3, 1.0 + (usage_rate * 0.3))
```

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«

```python
@dataclass
class UserProfile:
    uid: str
    yu_level: int
    player_level: int
    total_xp: int
    crystal_gauges: Dict[str, int]
    current_chapter: str
    daily_task_limit: int = 16  # ADHDé…æ…®
    care_points: int = 0
    guardian_permissions: List[str] = None
```

### ã‚¹ãƒˆãƒ¼ãƒªãƒ¼çŠ¶æ…‹

```python
@dataclass
class StoryState:
    uid: str
    current_chapter: str
    current_node: str
    available_edges: List[str]
    story_history: List[dict]
    last_generation_time: datetime
```

### ã‚¿ã‚¹ã‚¯è¨˜éŒ²

```python
@dataclass
class TaskRecord:
    task_id: str
    uid: str
    task_type: TaskType
    difficulty: int
    description: str
    completed: bool
    completion_time: Optional[datetime]
    xp_earned: int
    mood_at_completion: int
    linked_story_edge: Optional[str]
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### æ®µéšçš„ã‚¨ãƒ©ãƒ¼å‡¦ç†

1. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼**: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
2. **ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼**: ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«é•å
3. **å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¨ãƒ©ãƒ¼**: OpenAI APIã€Firestoreæ¥ç¶š
4. **ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼**: äºˆæœŸã—ãªã„ä¾‹å¤–

```python
class GameEngineError(Exception):
    def __init__(self, message: str, error_code: str, 
                 recovery_action: str = None):
        self.message = message
        self.error_code = error_code
        self.recovery_action = recovery_action
        super().__init__(message)

class ErrorHandler:
    def handle_xp_calculation_error(self, error: Exception) -> dict:
        return {
            "success": False,
            "error_code": "XP_CALC_FAILED",
            "message": "XPè¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ",
            "recovery_action": "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨"
        }
```

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### å˜ä½“ãƒ†ã‚¹ãƒˆ

- XPè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®æ­£ç¢ºæ€§
- ãƒ¬ãƒ™ãƒ«é€²è¡Œã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- å…±é³´ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ¡ä»¶
- ã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚²ãƒ¼ã‚¸é€²è¡Œ

### çµ±åˆãƒ†ã‚¹ãƒˆ

- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ç”Ÿæˆã¨ã‚¿ã‚¹ã‚¯é€£æº
- Mandalaã‚·ã‚¹ãƒ†ãƒ ã¨ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³é€£æº
- æ²»ç™‚å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯çµ±åˆ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

- AIå¿œç­”æ™‚é–“ï¼ˆ3.5ç§’ä»¥å†…ï¼‰
- åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ï¼ˆ20,000äººï¼‰
- APIå¿œç­”æ™‚é–“ï¼ˆ1.2ç§’ä»¥å†…ï¼‰

### æ²»ç™‚åŠ¹æœãƒ†ã‚¹ãƒˆ

- CBTä»‹å…¥ã®é©åˆ‡æ€§
- è‡ªå‚·ãƒªã‚¹ã‚¯æ¤œå‡ºç²¾åº¦ï¼ˆF1ã‚¹ã‚³ã‚¢98%ï¼‰
- ADHDé…æ…®æ©Ÿèƒ½ã®æœ‰åŠ¹æ€§

```python
class TestSuite:
    def test_xp_calculation(self):
        # XPè¨ˆç®—ã®æ­£ç¢ºæ€§ãƒ†ã‚¹ãƒˆ
        task = Task(TaskType.ROUTINE, difficulty=3, description="æœã®é‹å‹•")
        xp = task.calculate_xp(mood_coefficient=1.1, adhd_assist=1.2)
        assert xp == int(30 * 1.1 * 1.2)  # 39 XP
    
    def test_resonance_event(self):
        # å…±é³´ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿãƒ†ã‚¹ãƒˆ
        level_system = LevelSystem()
        assert level_system.check_resonance_event(yu_level=10, player_level=5)
        assert not level_system.check_resonance_event(yu_level=10, player_level=8)
    
    def test_therapeutic_safety(self):
        # æ²»ç™‚å®‰å…¨æ€§ãƒ†ã‚¹ãƒˆ
        safety = TherapeuticSafety()
        result = safety.validate_content("ãƒã‚¸ãƒ†ã‚£ãƒ–ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹")
        assert result["safe"] == True
        assert result["confidence"] < 0.02
```

## ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆUI/UXè¨­è¨ˆ

### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³æˆ¦ç•¥

#### ç”»é¢ã‚µã‚¤ã‚ºå¯¾å¿œ

```css
/* ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ CSSè¨­è¨ˆ */
.mobile-container {
  /* åŸºæœ¬: 320px-480px (ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç¸¦) */
  width: 100%;
  max-width: 480px;
  margin: 0 auto;
  padding: 16px;
}

@media (min-width: 481px) and (max-width: 768px) {
  /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç¸¦: 481px-768px */
  .mobile-container {
    max-width: 768px;
    padding: 24px;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæ¨ª: 769px-1024px */
  .mobile-container {
    max-width: 1024px;
    padding: 32px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }
}
```

#### ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼UIè¨­è¨ˆ

```python
class TouchUIConfig:
    """ã‚¿ãƒƒãƒæ“ä½œæœ€é©åŒ–è¨­å®š"""
    
    # ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚ºï¼ˆApple HIG & Material Designæº–æ‹ ï¼‰
    MIN_TOUCH_TARGET = 44  # px
    RECOMMENDED_TOUCH_TARGET = 48  # px
    
    # ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
    SWIPE_THRESHOLD = 50  # px
    TAP_TIMEOUT = 300  # ms
    LONG_PRESS_DURATION = 500  # ms
    
    # ADHDé…æ…®ã®ã‚¿ãƒƒãƒè¨­å®š
    ACCIDENTAL_TOUCH_PREVENTION = True
    DOUBLE_TAP_CONFIRMATION = True  # é‡è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨
    
    @staticmethod
    def get_touch_styles() -> dict:
        return {
            "button": {
                "min-height": "48px",
                "min-width": "48px",
                "padding": "12px 16px",
                "margin": "8px",
                "border-radius": "8px",
                "font-size": "16px",  # iOS zoomé˜²æ­¢
                "line-height": "1.5"
            },
            "input": {
                "min-height": "44px",
                "padding": "12px",
                "font-size": "16px",  # iOS zoomé˜²æ­¢
                "border-radius": "8px"
            }
        }
```

### Mandalaã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–

#### 3x3ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã®é©å¿œè¨­è¨ˆ

```python
class MobileMandalaRenderer:
    """ãƒ¢ãƒã‚¤ãƒ«å‘ã‘Mandalaè¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self, screen_width: int):
        self.screen_width = screen_width
        self.grid_size = self._calculate_optimal_grid_size()
        self.zoom_enabled = screen_width < 480
    
    def _calculate_optimal_grid_size(self) -> int:
        """ç”»é¢ã‚µã‚¤ã‚ºã«åŸºã¥ãæœ€é©ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºè¨ˆç®—"""
        if self.screen_width < 360:
            return 90  # å°å‹ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³
        elif self.screen_width < 480:
            return 110  # æ¨™æº–ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³
        elif self.screen_width < 768:
            return 140  # å¤§å‹ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³
        else:
            return 180  # ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ
    
    def render_mandala_grid(self, mandala_data: dict) -> dict:
        """ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã•ã‚ŒãŸMandalaã‚°ãƒªãƒƒãƒ‰æç”»"""
        return {
            "grid_config": {
                "cell_size": self.grid_size,
                "gap": 4,
                "total_width": (self.grid_size + 4) * 3 - 4,
                "touch_padding": 8
            },
            "interaction": {
                "zoom_enabled": self.zoom_enabled,
                "swipe_navigation": True,
                "long_press_info": True,
                "haptic_feedback": True
            },
            "accessibility": {
                "voice_over_labels": True,
                "high_contrast_mode": True,
                "large_text_support": True
            }
        }
    
    def handle_touch_interaction(self, touch_event: dict) -> dict:
        """ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†"""
        if touch_event["type"] == "tap":
            return self._handle_cell_tap(touch_event)
        elif touch_event["type"] == "long_press":
            return self._show_cell_info(touch_event)
        elif touch_event["type"] == "swipe":
            return self._handle_swipe_navigation(touch_event)
```

### LINE Bot ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–

#### ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã‚«ãƒ«ãƒ¼ã‚»ãƒ«è¨­è¨ˆ

```python
class MobileLINEBotUI:
    """LINE Bot ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–UI"""
    
    def create_morning_mandala_carousel(self, tasks: List[dict]) -> dict:
        """æœã®Mandalaå½¢å¼ã‚¿ã‚¹ã‚¯è¡¨ç¤ºï¼ˆ3x3ã‚°ãƒªãƒƒãƒ‰ï¼‰"""
        return {
            "type": "flex",
            "altText": "ä»Šæ—¥ã®ãƒãƒ¼ãƒˆã‚¯ãƒªã‚¹ã‚¿ãƒ«ã‚¿ã‚¹ã‚¯",
            "contents": {
                "type": "carousel",
                "contents": self._create_mandala_bubbles(tasks)
            }
        }
    
    def _create_mandala_bubbles(self, tasks: List[dict]) -> List[dict]:
        """3x3 Mandalaã‚’3ã¤ã®ãƒãƒ–ãƒ«ã«åˆ†å‰²"""
        bubbles = []
        
        # å„ãƒãƒ–ãƒ«ã«3x1ã®ã‚°ãƒªãƒƒãƒ‰ã‚’é…ç½®
        for i in range(3):
            bubble = {
                "type": "bubble",
                "size": "kilo",  # ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚µã‚¤ã‚º
                "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": []
                }
            }
            
            # 3ã¤ã®ã‚¿ã‚¹ã‚¯ã‚’ç¸¦ã«é…ç½®
            for j in range(3):
                task_index = i * 3 + j
                if task_index < len(tasks):
                    task_button = self._create_task_button(tasks[task_index])
                    bubble["body"]["contents"].append(task_button)
            
            bubbles.append(bubble)
        
        return bubbles
    
    def _create_task_button(self, task: dict) -> dict:
        """ã‚¿ãƒƒãƒãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¿ã‚¹ã‚¯ãƒœã‚¿ãƒ³"""
        return {
            "type": "button",
            "style": "primary",
            "height": "sm",
            "action": {
                "type": "postback",
                "label": f"âœ“ {task['title'][:10]}...",
                "data": f"complete_task_{task['id']}"
            }
        }
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°

```python
class MobilePerformanceOptimizer:
    """ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–"""
    
    def __init__(self):
        self.skeleton_screens = True
        self.lazy_loading = True
        self.image_optimization = True
    
    def create_skeleton_screen(self, component_type: str) -> dict:
        """ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç”Ÿæˆ"""
        skeletons = {
            "mandala_grid": {
                "type": "grid",
                "rows": 3,
                "cols": 3,
                "cell_height": "60px",
                "animation": "pulse"
            },
            "story_content": {
                "type": "text_blocks",
                "lines": [
                    {"width": "100%", "height": "20px"},
                    {"width": "80%", "height": "20px"},
                    {"width": "90%", "height": "20px"}
                ],
                "animation": "shimmer"
            },
            "task_list": {
                "type": "list_items",
                "count": 5,
                "item_height": "48px",
                "animation": "wave"
            }
        }
        return skeletons.get(component_type, {})
    
    def optimize_images(self, image_config: dict) -> dict:
        """ç”»åƒæœ€é©åŒ–è¨­å®š"""
        return {
            "formats": ["webp", "avif", "jpg"],
            "sizes": {
                "mobile": "320w",
                "tablet": "768w",
                "desktop": "1024w"
            },
            "lazy_loading": True,
            "placeholder": "blur",
            "quality": 85
        }
    
    def get_3g_optimization_config(self) -> dict:
        """3Gå›ç·šå¯¾å¿œæœ€é©åŒ–"""
        return {
            "bundle_splitting": True,
            "code_splitting": True,
            "resource_hints": ["preload", "prefetch"],
            "compression": "gzip",
            "caching_strategy": "stale-while-revalidate",
            "offline_support": True
        }
```

### ADHDé…æ…®ã®ãƒ¢ãƒã‚¤ãƒ«UX

#### èªçŸ¥è² è·è»½æ¸›è¨­è¨ˆ

```python
class ADHDMobileUX:
    """ADHDé…æ…®ã®ãƒ¢ãƒã‚¤ãƒ«UXè¨­è¨ˆ"""
    
    def __init__(self):
        self.max_choices_per_screen = 3
        self.auto_save_interval = 30  # seconds
        self.distraction_prevention = True
    
    def create_simplified_navigation(self) -> dict:
        """ã‚·ãƒ³ãƒ—ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ"""
        return {
            "type": "bottom_tab",
            "items": [
                {
                    "icon": "ğŸ ",
                    "label": "ãƒ›ãƒ¼ãƒ ",
                    "route": "/home",
                    "primary": True
                },
                {
                    "icon": "ğŸ“‹",
                    "label": "ã‚¿ã‚¹ã‚¯",
                    "route": "/tasks",
                    "badge_count": "dynamic"
                },
                {
                    "icon": "ğŸ“–",
                    "label": "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼",
                    "route": "/story",
                    "notification": "dynamic"
                }
            ],
            "max_items": 3,  # ADHDé…æ…®
            "large_touch_targets": True
        }
    
    def create_focus_mode_ui(self) -> dict:
        """é›†ä¸­ãƒ¢ãƒ¼ãƒ‰UI"""
        return {
            "distraction_blocking": {
                "hide_notifications": True,
                "minimal_ui": True,
                "single_task_focus": True
            },
            "break_reminders": {
                "interval": 25,  # Pomodoro
                "gentle_notification": True,
                "mother_concern_narrative": True
            },
            "progress_visualization": {
                "simple_progress_bar": True,
                "immediate_feedback": True,
                "celebration_animations": True
            }
        }
```

### ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£çµ±åˆ

#### JIS X 8341-3 AAAæº–æ‹ 

```python
class MobileAccessibility:
    """ãƒ¢ãƒã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å®Ÿè£…"""
    
    def __init__(self):
        self.wcag_level = "AAA"
        self.jis_compliance = True
        self.voice_over_support = True
    
    def get_accessibility_config(self) -> dict:
        """ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£è¨­å®š"""
        return {
            "color_contrast": {
                "normal_text": 7.0,  # AAA level
                "large_text": 4.5,
                "ui_components": 3.0
            },
            "font_scaling": {
                "min_size": "16px",
                "max_size": "24px",
                "dynamic_scaling": True
            },
            "touch_targets": {
                "min_size": "44px",
                "spacing": "8px",
                "clear_boundaries": True
            },
            "screen_reader": {
                "aria_labels": True,
                "semantic_html": True,
                "focus_management": True
            },
            "motor_accessibility": {
                "voice_control": True,
                "switch_control": True,
                "gesture_alternatives": True
            }
        }
```

ã“ã®è¨­è¨ˆæ–‡æ›¸ã¯ã€è¦ä»¶æ–‡æ›¸ã§å®šç¾©ã•ã‚ŒãŸå…¨ã¦ã®æ©Ÿèƒ½è¦ä»¶ã‚’æŠ€è¡“çš„ã«å®Ÿè£…å¯èƒ½ãªå½¢ã§è©³ç´°åŒ–ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®è¨­è¨ˆæ€æƒ³ã«åŸºã¥ãã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã®æœ€é©ãªæ²»ç™‚ä½“é¨“ã‚’æä¾›ã™ã‚‹ãŸã‚ã®UI/UXè¨­è¨ˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚