# 実装計画

- [x] 1. プロジェクト構造とコアインターフェースの設定





  - マイクロサービス用のディレクトリ構造を作成
  - 共有型定義とインターフェースを定義
  - 基本的な依存関係管理を設定
  - _要件: 1.1, 8.1_
-

- [x] 2. 共有データモデルとバリデーションの実装






- [x] 2.1 コアデータモデルインターフェースと型の作成











  - UserProfile、StoryState、TaskRecordのTypeScript/Python型を作成
  [ ] 2.2 8属性クリスタルシステムのモデル実装
 - データ整合性のためのバリデーション関数を実装
  [ ] 2.2 8属性クリスタルシステムのモデル実装
 - _要件: 1.2, 5.2_
-

- [x] 2.2 8属性クリスタルシステムのモデル実装







  - CRYSTAL_ATTRIBUTES定数とCrystalGaugeクラスを作成
  - クリスタル進行ロジックとチャプターアンロック機能を実装
  - クリスタルゲージの単体テストを作成
  - _要件: 4.2, 4.5_

- [x] 2.3 タスクタイプとXP計算モデルの実装






  - TaskType列挙型とTaskクラスを実装
  - XP計算式（difficulty × mood_coefficient × adhd_assist）を実装
  - タスクモデルとXP計算の単体テストを作成
  - _要件: 5.1, 5.2_

- [x] 3. コアゲームエンジンのXPとレベル管理構築





- [x] 3.1 レベルシステムの実装



  - 指数関数的レベル進行アルゴリズムを実装
  - 次レベルまでのXP計算機能を実装
  - レベル計算の単体テストを作成
  - _要件: 4.4, 4.5_

- [x] 3.2 共鳴イベントシステムの実装



  - ユウとプレイヤーのレベル差チェック機能を実装
  - 共鳴イベント発生条件（レベル差5以上）を実装
  - ボーナスXP計算機能を実装
  - 共鳴イベントの単体テストを作成
  - _要件: 4.4, 4.5_

- [x] 3.3 ゲームエンジンAPIエンドポイントの実装



  - XP追加、レベル更新、共鳴イベントチェックのAPI作成
  - エラーハンドリングとレスポンス形式の標準化
  - APIエンドポイントの統合テストを作成
  - _要件: 8.1, 8.2_
-


- [x] 4. Mandalaシステムの9x9グリッド実装




- [x] 4.1 MandalaGridクラスとデータ構造の実装






  - 9x9グリッド構造とメモリセル管理を実装
  - 中央価値観（ACT療法統合）の固定配置を実装
  - グリッドシリアライゼーション機能を実装
  - _要件: 4.1, 4.3_

- [x] 4.2 セルアンロック機能とAPI実装




  - セルアンロック条件チェック機能を実装
  - `/mandala/{uid}/grid` APIエンドポイントを実装
  - ロック状態管理とJSON応答形式を実装
  - Mandala APIの統合テストを作成
  - _要件: 4.1, 4.3_

- [x] 5. 認証サービスの基本実装





- [x] 5.1 RBAC権限システムの実装







  - 3つの権限レベル（view-only、task-edit、chat-send）を実装
  - ユーザー権限チェック機能を実装
  - 権限ベースのアクセス制御の単体テストを作成
  - _要件: 6.1_

- [x] 5.2 認証APIとミドルウェアの実装







  - JWT トークン検証ミドルウェアを実装
  - 認証エンドポイント（ログイン、トークン更新）を実装
  - 認証フローの統合テストを作成
  - _要件: 6.1, 10.3_

- [x] 6. タスク管理サービスの実装









- [x] 6.1 4種類のタスクタイプ管理機能の実装







  - Routine、One-Shot、Skill-Up、Socialタスクの作成機能を実装
  - タスク完了処理とXP計算統合を実装
  - タスク管理の単体テストを作成
  - _要件: 5.1, 5.5_

- [x] 6.2 Pomodoro統合とADHD支援機能の実装





  - Pomodoroセッション管理を実装
  - ADHD支援係数計算（使用頻度ベース）を実装
  - 60分連続作業時の自動休憩提案を実装
  - Pomodoro統合の単体テストを作成
  - _要件: 3.2, 5.3_

- [x] 6.3 タスク管理APIエンドポイントの実装







  - タスクCRUD操作のAPIを実装
  - 日次タスク制限（16タスク）の実装
  - タスク完了報告とXP付与のAPIを実装
  - タスク管理APIの統合テストを作成


  - _要件: 3.4, 5.1_

- [x] 7. 気分追跡サービスの実装





- [x] 7.1 日次気分ログ機能の実装



  - 1-5スケールの気分記録機能を実装
  - 気分係数計算（0.8-1.2範囲）を実装
  - 気分データの永続化を実装
  - 気分追跡の単体テストを作成
  - _要件: 5.4_


- [x] 7.2 気分ベースXP調整システムの実装

  - 気分ログとXP計算の統合を実装
  - 気分履歴分析機能を実装
  - 気分追跡APIエンドポイントを実装
  - 気分システムの統合テストを作成
  - _要件: 5.2, 5.4_

- [x] 8. AIストーリーエンジンの基本実装












- [x] 8.1 ストーリーDAG構造の実装


  - CHAPTER > NODE > EDGE階層構造を実装
  - ストーリー状態管理とナビゲーション機能を実装
  - 孤立ノード検出と自動マージ機能を実装
  - ストーリーDAGの単体テストを作成
  - _要件: 2.3, 2.4_

- [x] 8.2 GPT-4oストーリー生成統合の実装



  - OpenAI API統合とプロンプト構築を実装
  - 3.5秒タイムアウト制約の実装
  - JSONスキーマ検証とエラーハンドリングを実装
  - ストーリー生成の統合テストを作成
  - _要件: 2.1, 2.2_

- [x] 8.3 リアルタスクフック統合の実装






  - ストーリー選択肢とreal_task_id/habit_tagの連携を実装
  - 明日のMandalaへの反映機能を実装
  - タスク完了とストーリー進行の同期を実装
  - タスク-ストーリー統合の統合テストを作成
  - _要件: 1.4, 5.5_

- [x] 9. 治療安全性サービスの実装








- [x] 9.1 コンテンツモデレーション機能の実装







  - OpenAI Moderation API統合を実装
  - カスタム自傷リスク検出フィルターを実装
  - 98% F1スコア目標の検証機能を実装
  - 安全性チェックの単体テストを作成
  - _要件: 7.1, 7.5_



- [x] 9.2 CBTベース介入システムの実装





  - 否定的思考パターン検出を実装
  - 「ストーリーブレイク」ダイアログ生成を実装
  - 認知再構成支援機能を実装
  - CBT介入の統合テストを作成
  - _要件: 7.2_

- [x] 10. ADHD支援サービスの実装





- [x] 10.1 認知負荷軽減機能の実装


  - 「ワンスクリーン、ワンアクション」レイアウト制約を実装
  - 最大3選択肢制限を実装
  - BIZ UDGothicフォント設定と行間調整を実装
  - ADHD配慮UIの単体テストを作成
  - _要件: 3.1, 3.3_

- [x] 10.2 時間認識支援機能の実装


  - 15分ハーフタイムリマインダーを実装
  - デイリーバッファー機能（1日2回の延長）を実装
  - 時間認識支援の統合テストを作成
  - _要件: 3.5, 9.5_

- [x] 11. モバイル対応UI/UXコンポーネントの実装




- [x] 11.1 レスポンシブデザインシステムの実装





  - 320px-1024px対応のCSS Grid/Flexboxレイアウトを実装
  - タッチフレンドリーUI（44px最小タッチターゲット）を実装
  - プログレッシブローディングとスケルトンスクリーンを実装
  - モバイル対応の単体テストを作成
  - _要件: 9.1, 9.4_

- [x] 11.2 モバイル最適化Mandalaシステムの実装











  - 画面サイズ別グリッドサイズ計算機能を実装
  - スワイプナビゲーションとズーム機能を実装
  - タッチイベント処理（タップ、ロングプレス、スワイプ）を実装
  - モバイルMandalaの統合テストを作成
  - _要件: 9.5, 4.1_

- [x] 11.3 ADHD配慮モバイルUXの実装


  - シンプルナビゲーション（最大3項目）を実装
  - 集中モードUIと気を散らす要素の除去を実装
  - 自動保存とプログレス可視化を実装
  - ADHD配慮UXの統合テストを作成
  - _要件: 3.1, 9.2_

- [x] 12. LINE Botモバイル最適化の実装










- [x] 12.1 モバイル最適化LINE Bot UIの実装

  - LINE Messaging API統合を実装
  - 朝7時のモバイル最適化ハートクリスタルタスク配信を実装
  - タッチフレンドリーなワンタップタスク報告機能を実装
  - LINE Bot基本機能の統合テストを作成
  - _要件: 1.1, 1.2, 9.2_





- [x] 12.2 モバイル対応ストーリー配信の実装

  - 21:30のAIストーリー生成と配信を実装
  - モバイル最適化されたストーリー選択肢表示を実装
  - 3x3 Mandala形式のモバイル表示を実装
  - 夜間配信機能の統合テストを作成
  - _要件: 1.3, 1.4, 9.1_


- [x] 12.3 LINE Flexメッセージモバイル最適化の実装



  - カルーセル形式の3x3 Mandalaバブル表示を実装
  - コンパクトサイズ（kilo）でのタスクボタン配置を実装
  - モバイル画面での読みやすさ最適化を実装
  - Flexメッセージの統合テストを作成
  - _要件: 9.1, 9.2_

- [x] 12. データ永続化とFirestore統合













- [x] 12.1 Firestoreスキーマとコレクション設計の実装

  - ユーザープロファイル、タスク、ストーリー状態のコレクション作成
  - データ整合性制約とインデックス設定を実装
  - Firestoreセキュリティルールを実装
  - データベース統合の単体テストを作成
  - _要件: 8.2, 10.1_

- [x] 12.2 データアクセス層とリポジトリパターンの実装





  - 各サービス用のリポジトリクラスを実装
  - CRUD操作とクエリ最適化を実装
  - データアクセス層の統合テストを作成




  - _要件: 8.1, 8.2_

- [x] 13. Guardian Portal基本機能の実装



- [x] 13.1 Guardian認証とダッシュボードの実装

  - SAML/Magic Link認証統合を実装
  - 週次PDFレポート生成機能を実装
  - Guardian権限管理を実装
  - Guardian機能の統合テストを作成
  - _要件: 6.1, 6.2_

- [x] 13.2 ケアポイントシステムの実装



  - 企業向けケアポイント購入機能を実装
  - ユーザーへのケアポイント配布機能を実装
  - ADHD医療文書による50%割引機能を実装
  - ケアポイントシステムの統合テストを作成
  - _要件: 6.3, 6.4_

- [x] 14. パフォーマンス最適化と監視の実装





- [x] 14.1 API応答時間最適化の実装


  - 1.2秒P95レイテンシ目標の監視を実装
  - キャッシュ戦略とデータベースクエリ最適化を実装
  - レート制限（120req/min/IP）を実装
  - パフォーマンス監視の統合テストを作成
  - _要件: 8.1, 8.4_

- [x] 14.2 スケーラビリティとフェイルオーバーの実装


  - Cloud Run自動スケーリング設定を実装
  - マルチリージョンフェイルオーバー機能を実装
  - 99.95%アップタイム監視を実装
  - スケーラビリティテストを作成
  - _要件: 8.2, 8.3_

- [x] 15. エンドツーエンド統合とシステムテスト





- [x] 15.1 完全なユーザージャーニーテストの実装


  - 朝のタスク配信から夜のストーリー生成までの完全フローテストを作成
  - XP獲得、レベルアップ、共鳴イベントの統合テストを作成
  - Mandalaシステムとストーリー進行の統合テストを作成
  - _要件: 1.1-1.5, 4.1-4.5_

- [x] 15.2 治療安全性とADHD配慮の統合テスト


  - コンテンツモデレーションとCBT介入の統合テストを作成
  - ADHD配慮機能の完全テストを作成
  - 治療効果測定のためのメトリクス収集を実装
  - _要件: 3.1-3.5, 7.1-7.5_

- [x] 16. RPG経済システムとアイテム管理の実装





- [x] 16.1 コイン経済システムの実装


  - タスク完了と魔物討伐によるコイン報酬システムを実装
  - 難易度とパフォーマンスに基づくコイン計算を実装
  - インフレ制御機能（総コイン数に基づく調整）を実装
  - コイン経済システムの単体テストを作成
  - _要件: 11.1, 11.4_

- [x] 16.2 ガチャシステムとアイテム生成の実装


  - 5段階レアリティ（common〜legendary）のガチャシステムを実装
  - 単発・10連・プレミアムガチャの実装
  - 治療テーマに基づくアイテム生成システムを実装
  - ガチャシステムの統合テストを作成
  - _要件: 11.2, 11.5_

- [x] 16.3 装備システムと能力値ボーナスの実装


  - 6スロット装備システム（武器・防具・アクセサリ・消耗品×3）を実装
  - 6種類の能力値ボーナス（集中力・回復力・やる気・社会性・創造性・知恵）を実装
  - 装備による作業効率ボーナス計算を実装
  - 装備システムの統合テストを作成
  - _要件: 11.3_

- [x] 17. 職業システムと成長パスの実装




- [x] 17.1 基本職業システムの実装


  - 6つの基本職業（戦士・勇者・魔法使い・僧侶・賢者・忍者）を実装
  - 各職業の治療的焦点と能力値ボーナスを実装
  - 職業固有スキルシステムを実装
  - 基本職業システムの単体テストを作成
  - _要件: 12.1, 12.3_

- [x] 17.2 上級職業とアンロック条件の実装


  - パラディン・大魔法使い・影の達人などの上級職業を実装
  - 能力値・タスク完了率・イベント分岐に基づくアンロック条件を実装
  - 職業変更システムとストーリー統合を実装
  - 上級職業システムの統合テストを作成
  - _要件: 12.2, 12.4, 12.5_

- [x] 18. 内なる魔物バトルシステムの実装




- [x] 18.1 魔物タイプと弱点システムの実装


  - 4種類の治療的魔物（先延ばしドラゴン・不安の影・憂鬱の虚無・社会恐怖ゴブリン）を実装
  - 各魔物の弱点と対応する実世界行動の実装
  - ターンベースバトルシステムを実装
  - 魔物バトルの単体テストを作成
  - _要件: 13.1, 13.2_

- [x] 18.2 バトル報酬とCBT統合の実装


  - 魔物討伐時のコイン・アイテム報酬システムを実装
  - CBTベースの振り返りプロンプト生成を実装
  - 敗北時のサポートナラティブシステムを実装
  - バトル報酬システムの統合テストを作成
  - _要件: 13.3, 13.4, 13.5_

- [x] 19. ゲーム性強化とエンゲージメント機能の実装





- [x] 19.1 季節イベントとコミュニティ機能の実装


  - 季節イベント・期間限定チャレンジシステムを実装
  - オプションのギルドシステム（ピアサポート）を実装
  - コミュニティ目標と協力機能を実装
  - コミュニティ機能の統合テストを作成
  - _要件: 14.1, 14.3_

- [x] 19.2 プレステージシステムと長期エンゲージメントの実装


  - 分岐ストーリーラインと治療マイルストーン連携を実装
  - コスメティックカスタマイゼーション機能を実装
  - プレステージシステムとレガシー機能を実装
  - 長期エンゲージメントの統合テストを作成
  - _要件: 14.2, 14.4, 14.5_

- [x] 20. RPG要素統合とバランス調整





- [x] 20.1 全RPG要素の統合テスト


  - XP・コイン・装備・職業システムの完全統合テストを作成
  - 魔物バトルとタスク管理の統合テストを作成
  - 経済バランスとゲーム進行の調整を実装
  - _要件: 11.1-11.5, 12.1-12.5, 13.1-13.5_

- [x] 20.2 治療効果とゲーム性のバランス最適化


  - 治療的価値とゲーム要素のバランス検証を実装
  - ユーザーエンゲージメント指標の監視を実装
  - ゲーム要素が治療効果を阻害しないことの検証を実装
  - _要件: 14.1-14.5_

- [x] 21. 日次振り返りとグルノートシステムの実装




- [x] 21.1 グルノート構造化振り返りシステムの実装


  - 4つのカテゴリ（①現実世界で困っていること・②理想的な世界とは・③理想的な世界に住むあなたの感情は？・④明日から何が出来る？）の振り返りプロンプト生成を実装
  - ユーザー状態に基づくコンテキスト適応型プロンプトを実装
  - 振り返り内容の感情分析とキーワード抽出を実装
  - グルノートシステムの単体テストを作成
  - _要件: 15.2_

- [x] 21.2 LINE Bot振り返りUI統合の実装


  - 22:00の自動振り返りプロンプト配信を実装
  - Flexメッセージによる構造化振り返りフォームを実装
  - 振り返り完了時のXP付与（25 XP）を実装
  - 振り返りUI統合の統合テストを作成
  - _要件: 15.1, 15.3_

- [x] 21.3 振り返り継続支援とリマインダーの実装


  - 振り返りストリーク管理システムを実装
  - 2日連続スキップ時の優しいリマインダー機能を実装
  - 振り返りデータのストーリー生成への活用を実装
  - 継続支援システムの統合テストを作成
  - _要件: 15.4, 15.5_

- [x] 22. デプロイメントと本番環境設定





- [x] 22.1 本番環境インフラストラクチャの設定

  - Cloud Run、Firestore、Cloud Storageの本番設定を実装
  - VPC-SC、IAM Conditions、Cloud Armor WAFのセキュリティ設定を実装
  - Secret Manager KMSによる機密情報管理を実装
  - _要件: 16.2, 16.4_

- [x] 22.2 監視、ログ、アラートシステムの実装


  - アプリケーション監視とエラー追跡を実装
  - パフォーマンスメトリクスとアラート設定を実装
  - 治療安全性メトリクス（F1スコア）の継続監視を実装
  - _要件: 7.5, 8.1-8.4_
- [x] 23. Edge AI キャッシュ PoC の実装
- [x] 23.1 Edge AI推論エンジンの基盤実装
  - TensorFlow Lite/ONNX Runtime統合を実装
  - ローカル推論パイプラインの構築
  - モデル量子化と最適化機能を実装
  - Edge AI基盤の単体テストを作成
  - _要件: パフォーマンス向上、オフライン対応_

- [x] 23.2 インテリジェントキャッシュシステムの実装
  - ユーザー行動予測モデルの統合
  - 先読みキャッシュアルゴリズムの実装
  - キャッシュ効率最適化機能を実装
  - キャッシュシステムの統合テストを作成
  - _要件: レスポンス時間短縮、データ使用量削減_

- [x] 23.3 オフライン機能とデータ同期の実装
  - オフライン時のタスク管理機能を実装
  - データ同期とコンフリクト解決機能を実装
  - オフライン状態での治療継続支援を実装
  - オフライン機能の統合テストを作成
  - _要件: 接続不安定環境での継続利用_

- [x] 24. α版プレイテスト (n=50) の実装







- [x] 24.1 プレイテスト環境とデータ収集システムの実装




  - テストユーザー管理システムを実装
  - 行動ログ収集とプライバシー保護機能を実装
  - リアルタイム分析ダッシュボードを実装
  - テスト環境の統合テストを作成
  - _要件: ユーザビリティ検証、データ収集_

- [x] 24.2 フィードバック収集と分析システムの実装


  - アプリ内フィードバック機能を実装
  - 感情分析とテーマ抽出機能を実装
  - 改善提案の自動生成機能を実装
  - フィードバックシステムの統合テストを作成
  - _要件: ユーザー体験改善、治療効果検証_

- [x] 24.3 A/Bテスト機能とパフォーマンス測定の実装


  - 機能別A/Bテストフレームワークを実装
  - 治療効果の統計的検証機能を実装
  - パフォーマンス指標の自動収集を実装
  - A/Bテストシステムの統合テストを作成
  - _要件: エビデンスベース改善、統計的検証_

- [x] 25. GDPR/個人情報フロー監査の実装





- [x] 25.1 個人情報管理とプライバシー保護システムの実装


  - 個人情報の分類と管理機能を実装
  - データ最小化とプライバシーバイデザインを実装
  - 同意管理とオプトアウト機能を実装
  - プライバシー保護の単体テストを作成
  - _要件: GDPR準拠、プライバシー保護_

- [x] 25.2 データ処理の透明性と権利行使支援の実装


  - データ処理目的の明示機能を実装
  - アクセス権・訂正権・削除権の実装
  - データポータビリティ機能を実装
  - 権利行使システムの統合テストを作成
  - _要件: GDPR第12-22条準拠_


- [x] 25.3 監査ログとコンプライアンス監視の実装

  - 個人情報アクセスログの記録機能を実装
  - GDPR準拠状況の自動監視を実装
  - データ保護影響評価（DPIA）支援機能を実装
  - コンプライアンス監視の統合テストを作成
  - _要件: 監査対応、継続的コンプライアンス_

- [x] 26. 実装品質改善とデプロイ準備








- [x] 26.1 UNICODE文字エンコーディング問題の修正


  - 全サービスファイルのUNICODE文字（[UNICODE_XXXX]）を適切な日本語文字に変換
  - Python実行時のエンコーディングエラーを解決
  - 文字化けによる実行エラーを修正
  - エンコーディング修正の検証テストを作成


  - _要件: 基本動作保証、実行可能性確保_
-



- [x] 26.2 依存関係とインポートエラーの解決


  - shared interfacesの循環参照問題を解決
  - 不足している依存関係パッケージを特定・インストール
  - import pathの問題を修正
  - 各サービスの独立動作を確認
  - _要件: サービス間連携、モジュール構造最適化_

- [x] 26.3 コアサービスの動作確認と修正


  - Core Game Engine (port 8001) の正常起動を確認
  - Authentication Service (port 8002) の正常起動を確認
  - Task Management Service (port 8003) の正常起動を確認
  - 各サービスのhealth checkエンドポイントを検証
  - _要件: 基本サービス動作保証_
-

- [x] 26.4 API連携とエンドポイント検証













  - サービス間API呼び出しの動作確認
  - エラーハンドリングの適切性を検証
  - レスポンス形式の統一性を確認
  - CORS設定の正常動作を確認
  - _要件: サービス間通信、API仕様準拠_
-

- [x] 26.5 ローカルデプロイメントシステムの完成










  - deploy_local.pyの動作確認と修正
  - 全サービスの同時起動機能を実装
  - サービス監視とヘルスチェック機能を実装
  - ゲームランチャーHTMLの動作確認
  - _要件: 開発環境構築、デプロイ自動化_
-


- [x] 27. 最小動作版（MVP）の作成








- [x] 27.1 最小機能セットの特定と実装



  - ユーザー登録・認証の基本機能
  - タスク作成・完了・XP獲得の基本フロー
  - 簡単なレベルアップシステム
  - 基本的なMandalaグリッド表示
  - _要件: 核心機能の動作確認_

- [x] 27.2 統合テストとエンドツーエンドテスト







  - ユーザージャーニー全体の動作確認
  - 朝のタスク配信から夜のストーリー生成までの基本フロー
  - データ永続化の動作確認
  - エラー処理の適切性確認
  - _要件: システム全体の動作保証_



- [x] 27.3 パフォーマンスとスケーラビリティの基本確認











  - 同時接続数の基本テスト（10-50ユーザー）
  - API応答時間の測定と最適化
  - メモリ使用量とCPU使用率の監視
  - 基本的なロードテストの実行
  - _要件: 基本性能要件の確認_

- [x] 28. デプロイメント準備と本番環境設定






- [x] 28.1 本番環境設定の検証


  - Google Cloud Platform設定の確認
  - Firestore、Cloud Run、Secret Manager設定の検証
  - セキュリティ設定（VPC-SC、IAM、Cloud Armor）の確認
  - 監視・ログ設定の動作確認
  - _要件: 本番環境準備、セキュリティ確保_

- [x] 28.2 CI/CDパイプラインの構築


  - 自動テスト実行パイプラインの構築
  - 自動デプロイメントスクリプトの作成
  - ロールバック機能の実装
  - デプロイメント監視とアラート設定
  - _要件: 継続的インテグレーション、デプロイ自動化_

- [x] 28.3 最終動作確認とリリース準備




  - 全機能の統合テスト実行
  - セキュリティ監査とペネトレーションテスト
  - パフォーマンステストとスケーラビリティ確認
  - ドキュメント整備とユーザーマニュアル作成
  - _要件: リリース品質保証、運用準備完了_