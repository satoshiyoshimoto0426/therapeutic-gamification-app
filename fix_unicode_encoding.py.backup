#!/usr/bin/env python3
"""
UNICODEæ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å•é¡Œä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
[UNICODE_XXXX] å½¢å¼ã®æ–‡å­—ã‚’é©åˆ‡ãªæ—¥æœ¬èªæ–‡å­—ã«å¤‰æ›
"""

import os
import re
import glob
from typing import Dict, List

# UNICODEæ–‡å­—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚‚ã®ï¼‰
UNICODE_MAPPING = {
    # ã‚³ãƒ¡ãƒ³ãƒˆãƒ»èª¬æ˜ç³»
    '[UNICODE_30B3]': 'ã‚³ã‚¢',
    '[UNICODE_30A2]': 'ã‚¢ãƒ—ãƒª',
    '[UNICODE_30ED]': 'ãƒ­ã‚°',
    '[UNICODE_8A2D]': 'è¨­å®š',
    '[UNICODE_5171]': 'å…±æœ‰',
    '[UNICODE_30D7]': 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼',
    '[UNICODE_30E6]': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
    '[UNICODE_30EC]': 'ãƒ¬ãƒ™ãƒ«',
    '[UNICODE_30B7]': 'ã‚·ã‚¹ãƒ†ãƒ ',
    '[UNICODE_30B2]': 'ã‚²ãƒ¼ãƒ ',
    '[UNICODE_30A8]': 'ã‚¨ãƒ©ãƒ¼',
    '[UNICODE_30D8]': 'ãƒ˜ãƒ«ãƒ‘ãƒ¼',
    '[UNICODE_30BF]': 'ã‚¿ã‚¹ã‚¯',
    '[UNICODE_6C17]': 'æ°—åˆ†',
    '[UNICODE_30D0]': 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³',
    '[UNICODE_30C7]': 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ',
    '[UNICODE_4FC2]': 'ä¿‚æ•°',
    '[UNICODE_652F]': 'æ”¯æ´',
    '[UNICODE_57FA]': 'åŸºæœ¬',
    '[UNICODE_8A08]': 'è¨ˆç®—',
    '[UNICODE_30D7]': 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
    '[UNICODE_5165]': 'å…¥åŠ›',
    '[UNICODE_5185]': 'å†…éƒ¨',
    '[UNICODE_4E00]': 'ä¸€èˆ¬',
    '[UNICODE_8D77]': 'èµ·å‹•',
    '[UNICODE_7BA1]': 'ç®¡ç†',
    '[UNICODE_30E2]': 'ãƒ¢ãƒ‡ãƒ«',
    '[UNICODE_6CBB]': 'æ²»ç™‚',
    '[UNICODE_81EA]': 'è‡ªå‹•',
    '[UNICODE_30AB]': 'ã‚«ã‚¹ã‚¿ãƒ ',
    '[UNICODE_6587]': 'æ–‡å­—',
    '[UNICODE_30B9]': 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼',
    '[UNICODE_7269]': 'ç‰©èª',
    '[UNICODE_8105]': 'ç·åˆ',
    '[UNICODE_5B89]': 'å®‰å…¨',
    '[UNICODE_691C]': 'æ¤œè¨¼',
    '[UNICODE_4FE1]': 'ä¿¡é ¼',
    '[UNICODE_30EA]': 'ãƒªã‚¹ãƒˆ',
    '[UNICODE_30D3]': 'ãƒ“ã‚¸ãƒã‚¹',
    '[UNICODE_5B9F]': 'å®Ÿè£…',
    '[UNICODE_3053]': 'ã“ã®',
    '[UNICODE_30E1]': 'ãƒ¡ã‚¤ãƒ³',
    '[UNICODE_4F7F]': 'ä½¿ç”¨',
    '[UNICODE_30B7]': 'ã‚·ã‚¹ãƒ†ãƒ ',
    '[UNICODE_6E96]': 'æº–æ‹ ',
    
    # æ—¥æœ¬èªã®åŸºæœ¬æ–‡å­—
    '[UNICODE_6B7B]': 'æ­»',
    '[UNICODE_6D88]': 'æ¶ˆ',
    '[UNICODE_3044]': 'ã„',
    '[UNICODE_50B7]': 'å‚·',
    '[UNICODE_3060]': 'ã ',
    '[UNICODE_3082]': 'ã‚‚',
    '[UNICODE_9650]': 'é™',
    '[UNICODE_8010]': 'è€',
    '[UNICODE_7D42]': 'çµ‚',
    '[UNICODE_8AB0]': 'èª°',
    '[UNICODE_307F]': 'ã¿',
    '[UNICODE_5ACC]': 'å«Œ',
    '[UNICODE_618E]': 'æ†',
    '[UNICODE_8A31]': 'è¨±',
    '[UNICODE_4FA1]': 'ä¾¡',
    '[UNICODE_610F]': 'æ„',
    '[UNICODE_7121]': 'ç„¡',
    '[UNICODE_6210]': 'æˆ',
    '[UNICODE_5E0C]': 'å¸Œ',
    '[UNICODE_3064]': 'ã¤',
    '[UNICODE_7406]': 'ç†',
    '[UNICODE_52C7]': 'å‹‡',
    '[UNICODE_6311]': 'æŒ‘',
    '[UNICODE_5B66]': 'å­¦',
    '[UNICODE_767A]': 'ç™º',
    '[UNICODE_5275]': 'å‰µ',
    '[UNICODE_8868]': 'è¡¨',
    
    # ãã®ä»–ã‚ˆãä½¿ã‚ã‚Œã‚‹æ–‡å­—
    '[UNICODE_3067]': 'ã§',
    '[UNICODE_304B]': 'ã‹',
    '[UNICODE_306E]': 'ã®',
    '[UNICODE_3092]': 'ã‚’',
    '[UNICODE_306B]': 'ã«',
    '[UNICODE_304C]': 'ãŒ',
    '[UNICODE_3068]': 'ã¨',
    '[UNICODE_3057]': 'ã—',
    '[UNICODE_3066]': 'ã¦',
    '[UNICODE_3059]': 'ã™',
    '[UNICODE_308B]': 'ã‚‹',
    '[UNICODE_3093]': 'ã‚“',
    '[UNICODE_3042]': 'ã‚',
    '[UNICODE_3048]': 'ãˆ',
    '[UNICODE_304A]': 'ãŠ',
    '[UNICODE_304D]': 'ã',
    '[UNICODE_304F]': 'ã',
    '[UNICODE_3051]': 'ã‘',
    '[UNICODE_3053]': 'ã“',
    '[UNICODE_3055]': 'ã•',
    '[UNICODE_305F]': 'ãŸ',
    '[UNICODE_306A]': 'ãª',
    '[UNICODE_306F]': 'ã¯',
    '[UNICODE_307E]': 'ã¾',
    '[UNICODE_3084]': 'ã‚„',
    '[UNICODE_3089]': 'ã‚‰',
    '[UNICODE_308F]': 'ã‚',
}

def find_files_with_unicode_issues(directory: str = ".") -> List[str]:
    """UNICODEæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢"""
    files_with_issues = []
    
    # Python ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    for pattern in ["**/*.py", "**/*.md", "**/*.txt"]:
        for file_path in glob.glob(os.path.join(directory, pattern), recursive=True):
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    if '[UNICODE_' in content:
                        files_with_issues.append(file_path)
            except Exception as e:
                print(f"âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ {file_path}: {e}")
    
    return files_with_issues

def fix_unicode_in_file(file_path: str) -> bool:
    """ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®UNICODEæ–‡å­—ã‚’ä¿®æ­£"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        original_content = content
        
        # UNICODEæ–‡å­—ã‚’ç½®æ›
        for unicode_char, replacement in UNICODE_MAPPING.items():
            content = content.replace(unicode_char, replacement)
        
        # æœªçŸ¥ã®UNICODEæ–‡å­—ã‚’æ¤œå‡º
        unknown_unicode = re.findall(r'\[UNICODE_[A-F0-9]+\]', content)
        if unknown_unicode:
            print(f"âš ï¸ æœªçŸ¥ã®UNICODEæ–‡å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ in {file_path}: {set(unknown_unicode)}")
            # æœªçŸ¥ã®æ–‡å­—ã¯å‰Šé™¤ã¾ãŸã¯é©åˆ‡ãªæ–‡å­—ã«ç½®æ›
            for unknown in set(unknown_unicode):
                content = content.replace(unknown, '?')  # ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        
        # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        if content != original_content:
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            return True
        
        return False
        
    except Exception as e:
        print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ã‚¨ãƒ©ãƒ¼ {file_path}: {e}")
        return False

def create_backup(file_path: str):
    """ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ"""
    backup_path = file_path + '.backup'
    try:
        with open(file_path, 'r', encoding='utf-8') as original:
            with open(backup_path, 'w', encoding='utf-8') as backup:
                backup.write(original.read())
        print(f"ğŸ“‹ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: {backup_path}")
    except Exception as e:
        print(f"âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå¤±æ•— {file_path}: {e}")

def main():
    print("ğŸ”§ UNICODEæ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å•é¡Œä¿®æ­£é–‹å§‹")
    print("="*50)
    
    # å•é¡Œã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
    print("ğŸ” UNICODEæ–‡å­—ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­...")
    problem_files = find_files_with_unicode_issues()
    
    if not problem_files:
        print("âœ… UNICODEæ–‡å­—ã®å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
        return
    
    print(f"ğŸ“‹ {len(problem_files)} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:")
    for file_path in problem_files[:10]:  # æœ€åˆã®10å€‹ã‚’è¡¨ç¤º
        print(f"  - {file_path}")
    
    if len(problem_files) > 10:
        print(f"  ... ãŠã‚ˆã³ {len(problem_files) - 10} å€‹ã®è¿½åŠ ãƒ•ã‚¡ã‚¤ãƒ«")
    
    # ä¿®æ­£å®Ÿè¡Œã®ç¢ºèª
    response = input("\nğŸ¤” ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ (y/N): ")
    if response.lower() != 'y':
        print("âŒ ä¿®æ­£ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ")
        return
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£
    print("\nğŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£ä¸­...")
    fixed_count = 0
    
    for file_path in problem_files:
        print(f"ğŸ“ ä¿®æ­£ä¸­: {file_path}")
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
        create_backup(file_path)
        
        # ä¿®æ­£å®Ÿè¡Œ
        if fix_unicode_in_file(file_path):
            fixed_count += 1
            print(f"âœ… ä¿®æ­£å®Œäº†: {file_path}")
        else:
            print(f"âš ï¸ å¤‰æ›´ãªã—: {file_path}")
    
    print(f"\nğŸ‰ ä¿®æ­£å®Œäº†: {fixed_count}/{len(problem_files)} ãƒ•ã‚¡ã‚¤ãƒ«")
    
    # æ¤œè¨¼
    print("\nğŸ” ä¿®æ­£çµæœã‚’æ¤œè¨¼ä¸­...")
    remaining_issues = find_files_with_unicode_issues()
    
    if remaining_issues:
        print(f"âš ï¸ ã¾ã  {len(remaining_issues)} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚Šã¾ã™")
        for file_path in remaining_issues[:5]:
            print(f"  - {file_path}")
    else:
        print("âœ… ã™ã¹ã¦ã®UNICODEæ–‡å­—å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸï¼")
    
    print("\nğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("1. ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å‹•ä½œç¢ºèª")
    print("2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ*.backupï¼‰ã®å‰Šé™¤")
    print("3. ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ãƒ†ã‚¹ãƒˆ")

if __name__ == "__main__":
    main()